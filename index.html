<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PontoView • Previsão do Tempo</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="./pv-base.css?v=5">

  <style>
    :root{
      --panelSoft:#f6f9fe;

      --anim: 520ms;
      --ease: cubic-bezier(.2,.8,.2,1);

      /* ALERT forte */
      --warnBg:#fff0c2;
      --warnInk:#5a3a00;
      --warnLine:#f2c66a;
      --warnHot:#f59e0b;
    }

    /* =========================
       FIX 720p (1280x720)
       ========================= */
    /* reduz um pouco “densidade” em telas baixas */
    @media (max-height: 740px){
      :root{
        --safe: 12px;
        --pad:  14px;
        --gap:  12px;
        --footerH: 56px;

        /* deixa tipografia um pouco menor em 720p */
        --t-title: clamp(18px, 1.4vw, 28px);
        --t-sub:   clamp(11px, 0.85vw, 14px);
        --t-clock: clamp(28px, 2.8vw, 48px);
      }

      .todayHead{ padding: 14px 14px 8px; }
      .todayCenter{ padding: 6px 14px 0; }
      .todayBottom{ padding: 12px 14px 14px; }

      .slot{ padding: 12px; }
      .view{ inset: 12px; }

      .tempBig{ font-size: clamp(64px, 6.4vw, 120px); }
      .condLine{ margin-top: 8px; font-size: 13px; }

      .mVal{ font-size: 16px; }
      .mIcon{ width:32px; height:32px; }

      .fRow{ padding: 10px; gap: 10px; }
      .fDow{ font-size: 13px; }
      .fSub{ font-size: 10px; }

      /* evita sobreposição: permite scroll interno na coluna direita */
      .forecastList{ overflow:auto; }
      .side{ min-height: 0; }
    }

    /* se mesmo assim apertar em 720p (ou em players que ampliam fonte),
       empilha o layout em 1 coluna */
    @media (max-width: 1280px) and (max-height: 740px){
      .layout{ grid-template-columns: 1fr; }
      .side{ max-height: 42vh; } /* mantém a parte direita menor */
      .todayCard{ min-height: 0; }
    }

    /* ===== SUBBAR extras ===== */
    .sourceTag{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#3b4b62;
      opacity:.95;
      white-space:nowrap;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e7e9ee;
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
    }

    /* ALERT */
    .alertPill{
      display:none;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background: var(--warnBg);
      border:2px solid var(--warnLine);
      color: var(--warnInk);
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform:uppercase;
      white-space:nowrap;
      box-shadow:
        0 10px 24px rgba(245,158,11,.18),
        0 0 0 0 rgba(245,158,11,.35);
      animation: alertGlow 1.2s var(--ease) infinite;
    }
    .alertPill.show{display:inline-flex;}
    .alertPill svg{width:18px; height:18px; flex:0 0 auto;}
    .alertPulse{
      width:10px; height:10px; border-radius:999px;
      background:var(--warnHot);
      box-shadow: 0 0 0 0 rgba(245,158,11,.45);
      animation: alertPulse 1.2s var(--ease) infinite;
    }
    @keyframes alertPulse{
      0%{box-shadow:0 0 0 0 rgba(245,158,11,.45)}
      70%{box-shadow:0 0 0 14px rgba(245,158,11,0)}
      100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}
    }
    @keyframes alertGlow{
      0%,100%{box-shadow: 0 10px 24px rgba(245,158,11,.18), 0 0 0 0 rgba(245,158,11,.25)}
      50%{box-shadow: 0 14px 30px rgba(245,158,11,.26), 0 0 0 6px rgba(245,158,11,.08)}
    }

    /* ===== MAIN ===== */
    .pvMain{
      flex:1 1 auto;
      min-height:0;
      padding:var(--pad);
      display:flex;
      overflow:hidden;
    }
    .layout{
      width:100%;
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: var(--gap);
      align-items: stretch;
      min-height:0;
    }
    @media (max-aspect-ratio: 4/3){
      .layout{grid-template-columns:1fr;}
    }

    /* ===== HOJE (ESQUERDA) ===== */
    .todayCard{
      border:1px solid var(--line);
      border-radius: 20px;
      background:#fff;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .todayHead{
      padding: 18px 18px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      min-width:0;
      flex:0 0 auto;
    }
    .city{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#1a2a40;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .todayCenter{
      padding: 8px 18px 0;
      flex:1 1 auto;
      min-height:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .todayWrap{
      width:100%;
      max-width: 780px;
      display:grid;
      grid-template-columns: clamp(86px, 8.5vw, 140px) 1fr;
      align-items:center;
      gap: clamp(12px, 1.3vw, 18px);
    }
    .todayIcon{
      width: clamp(86px, 8.5vw, 140px);
      height: clamp(86px, 8.5vw, 140px);
      display:grid;
      place-items:center;
      color:#0f3d63;
      opacity:.95;
    }
    .todayIcon svg{width:100%; height:100%}

    .tempBlock{min-width:0}
    .tempBig{
      font-size: clamp(72px, 6.9vw, 140px);
      font-weight: 900;
      letter-spacing:-0.03em;
      line-height: .92;
      white-space:nowrap;
    }
    .tempBig small{font-size:.42em; font-weight: 900; opacity:.92}
    .condLine{
      margin-top: 10px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#2a3a50;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .todayBottom{
      padding: 14px 18px 16px;
      border-top:1px solid var(--line);
      background:#fff;
      flex:0 0 auto;
    }

    .metricsRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      align-items:stretch;
    }
    @media (max-width: 1100px){
      .metricsRow{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width: 680px){
      .metricsRow{grid-template-columns: 1fr;}
    }

    .mCard{
      background:#f1f3f5;
      border:1px solid #eceff3;
      border-radius: 14px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-width:0;
    }
    .mLeft{display:flex; align-items:center; gap:10px; min-width:0;}
    .mIcon{
      width:34px; height:34px;
      border-radius: 12px;
      background:#fff;
      border:1px solid #e7e9ee;
      display:grid; place-items:center;
      color:#1a2a40;
      opacity:.9;
      flex:0 0 auto;
      overflow: visible; /* importante p/ animação */
    }
    .mIcon svg{width:62%; height:62%}
    .mLabel{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#3b4b62;
      white-space:nowrap;
    }
    .mVal{
      font-size: 18px;
      font-weight: 900;
      white-space:nowrap;
      color:#0e1b2a;
    }

    /* ===== DIREITA (ALTERNÂNCIA) ===== */
    .side{
      border:1px solid var(--line);
      border-radius: 20px;
      background:#fff;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sideHeader{
      padding: 14px 16px;
      background: var(--panelSoft);
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex:0 0 auto;
    }
    .sideHeader .label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      color:#3b4b62;
      white-space:nowrap;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toggleDots{display:flex; gap:8px; align-items:center;}
    .tdot{width:10px; height:10px; border-radius:999px; background:#c9d7ea; transition: all 420ms var(--ease);}
    .tdot.active{background:#2d76b9; width:22px;}

    .slot{
      position:relative;
      flex:1 1 auto;
      padding: 16px;
      min-height:0;
      background:#fff;
      overflow:hidden;
    }
    .view{
      position:absolute;
      inset: 16px;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity var(--anim) var(--ease), transform var(--anim) var(--ease);
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
    }
    .view.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    /* ===== Próximos dias ===== */
    .forecastList{
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
      overflow:auto;
      overscroll-behavior: contain;
      scrollbar-width: none;
    }
    .forecastList::-webkit-scrollbar{ width:0; height:0; }

    .fRow{
      background:#f1f3f5;
      border:1px solid #eceff3;
      border-radius: 14px;
      padding: 12px;
      display:grid;
      grid-template-columns: 56px 44px 1fr auto;
      align-items:center;
      gap: 12px;
      min-width:0;
    }
    .fDow{
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      color:#1a2a40;
      white-space:nowrap;
    }
    .fIcon{
      width:44px; height:44px;
      border-radius: 14px;
      background:#fff;
      border:1px solid #e7e9ee;
      display:grid;
      place-items:center;
      color:#0f3d63;
      opacity:.95;
      flex:0 0 auto;
    }
    .fIcon svg{width:70%; height:70%}
    .fMid{min-width:0; display:flex; flex-direction:column; gap:6px;}
    .fBadge{
      display:inline-flex;
      align-items:center;
      padding: 8px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e7e9ee;
      width: fit-content;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      color:#23344a;
    }
    .fSub{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#3b4b62;
      opacity:.92;
      white-space:nowrap;
    }
    .fTemps{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      white-space:nowrap;
      font-weight: 900;
    }
    .pill{
      position: relative;
      padding: 10px 12px 8px;
      min-width: 52px;
      border-radius: 999px;
      background:#fff;
      border:1px solid #e7e9ee;
      font-size: 12px;
      font-weight: 900;
      color:#0e1b2a;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .pillTag{
      position:absolute;
      top:5px;
      left:50%;
      transform:translateX(-50%);
      font-size: 9px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .55;
      line-height: 1;
      pointer-events:none;
    }
    .pillTemp{
      display:block;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 900;
    }

    /* ===== Detalhes de HOJE (view B) ===== */
    .detailCard{
      border:1px solid #eef2f7;
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
    }
    .bigMinMax{
      display:flex;
      gap: 18px;
      align-items:flex-end;
      justify-content:flex-start;
      padding: 6px 2px 4px;
      flex-wrap:wrap;
    }
    .mmBlock{display:flex; align-items:baseline; gap:10px;}
    .mmNum{
      font-size: clamp(42px, 3.4vw, 62px);
      font-weight: 900;
      letter-spacing:-0.02em;
      line-height:1;
      color:#0e1b2a;
      white-space:nowrap;
    }
    .mmLbl{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#7a8697;
      white-space:nowrap;
    }
    .detailPills{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .dPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e7e9ee;
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      color:#23344a;
      white-space:nowrap;
    }
    .dPill svg{width:16px;height:16px;opacity:.9}

    /* ===== ÍCONE HOJE animado ===== */
    .animFloat{
      animation: floaty 2.8s var(--ease) infinite;
      transform-origin: 50% 50%;
      will-change: transform;
    }
    @keyframes floaty{
      0%,100%{transform: translateY(0)}
      50%{transform: translateY(-6px)}
    }
    .animRainDrop{animation: drop 1.2s linear infinite;}
    @keyframes drop{
      0%{transform: translateY(-2px); opacity:.2}
      35%{opacity:1}
      100%{transform: translateY(10px); opacity:0}
    }
    .animLightning{
      animation: flash 1.1s var(--ease) infinite;
      transform-origin: 50% 50%;
    }
    @keyframes flash{
      0%,60%,100%{opacity:1; transform: scale(1)}
      30%{opacity:.2; transform: scale(.98)}
    }

    /* =========================================================
       ✅ FIX ANIMAÇÃO SENSAÇÃO TÉRMICA (INDEPENDENTE DO pv-base)
       - anima o SVG dentro de #icFeel (mais confiável em players)
       - frio <= 19°C
       ========================================================= */
    #icFeel{ position: relative; }
    #icFeel svg{ transform-origin: 50% 50%; will-change: transform, filter; }

    /* quente: "tremor leve" + brilho */
    #icFeel.feel-hot svg{
      animation: pvFeelHot 900ms cubic-bezier(.2,.8,.2,1) infinite;
      filter: drop-shadow(0 0 0 rgba(245,158,11,0));
    }
    #icFeel.feel-hot-extreme svg{
      filter: drop-shadow(0 0 10px rgba(245,158,11,.35));
    }

    /* frio: "tremor lateral" + brilho */
    #icFeel.feel-cold svg{
      animation: pvFeelCold 1200ms cubic-bezier(.2,.8,.2,1) infinite;
      filter: drop-shadow(0 0 0 rgba(59,130,246,0));
    }
    #icFeel.feel-cold-extreme svg{
      filter: drop-shadow(0 0 10px rgba(59,130,246,.28));
    }

    /* “sheen”/aura no fundo (extremo) */
    #icFeel.feel-hot-extreme::after,
    #icFeel.feel-cold-extreme::after{
      content:"";
      position:absolute; inset:-30%;
      border-radius:999px;
      pointer-events:none;
      opacity:0;
      transform: rotate(0deg);
      animation: pvFeelSheen 1.1s cubic-bezier(.2,.8,.2,1) infinite;
      mix-blend-mode: multiply;
    }
    #icFeel.feel-hot-extreme::after{
      background: radial-gradient(circle at 35% 35%, rgba(245,158,11,.35) 0%, rgba(245,158,11,0) 55%);
    }
    #icFeel.feel-cold-extreme::after{
      background: radial-gradient(circle at 35% 35%, rgba(59,130,246,.28) 0%, rgba(59,130,246,0) 55%);
    }

    @keyframes pvFeelHot{
      0%,100%{ transform: translateY(0) rotate(0deg) }
      25%{ transform: translateY(-1px) rotate(-1.2deg) }
      50%{ transform: translateY(0) rotate(0.9deg) }
      75%{ transform: translateY(1px) rotate(-0.6deg) }
    }
    @keyframes pvFeelCold{
      0%,100%{ transform: translateX(0) }
      20%{ transform: translateX(-1px) }
      40%{ transform: translateX(1px) }
      60%{ transform: translateX(-1px) }
      80%{ transform: translateX(1px) }
    }
    @keyframes pvFeelSheen{
      0%{ opacity:0; transform: rotate(0deg) scale(.98) }
      35%{ opacity:.9; transform: rotate(18deg) scale(1.02) }
      70%{ opacity:.15; transform: rotate(36deg) scale(1.04) }
      100%{ opacity:0; transform: rotate(52deg) scale(1.02) }
    }
  </style>
</head>

<body>
  <div class="pvPage">
    <div class="pvShell" id="panel" data-title="PREVISÃO DO TEMPO" data-subtitle="LOCAL • ES">

      <header class="pvHeader">
        <div class="pvHeaderLeft">
          <div class="pvIconBadge" aria-hidden="true" id="hdrIcon"></div>
          <div class="pvTitles">
            <h1 class="pvTitle" id="title"></h1>
            <div class="pvSubtitle" id="subtitle"></div>
          </div>
        </div>
        <div class="pvHeaderRight">
          <div class="pvClock" id="pvClock">--:--</div>
        </div>
      </header>

      <div class="pvSubbar">
        <div class="pvSubLeft" id="subLeft">HOJE • PRÓXIMOS DIAS</div>
        <div class="pvSubRight">
          <div class="sourceTag" id="subSource">FONTE • OPEN-METEO</div>

          <div class="alertPill" id="alertTop">
            <span class="alertPulse" aria-hidden="true"></span>
            <span id="alertIcon" aria-hidden="true"></span>
            <span id="alertTopText">ALERTA • —</span>
          </div>
        </div>
      </div>

      <main class="pvMain">
        <div class="layout">
          <!-- ESQUERDA: HOJE -->
          <section class="todayCard">
            <div class="todayHead">
              <div class="city" id="cityName">—</div>
            </div>

            <div class="todayCenter">
              <div class="todayWrap">
                <div class="todayIcon" id="todayIcon" aria-hidden="true"></div>
                <div class="tempBlock">
                  <div class="tempBig" id="tempToday">--<small>°C</small></div>
                  <div class="condLine" id="descToday">CARREGANDO…</div>
                </div>
              </div>
            </div>

            <div class="todayBottom">
              <div class="metricsRow">
                <div class="mCard">
                  <div class="mLeft">
                    <div class="mIcon" aria-hidden="true" id="icFeel"></div>
                    <div class="mLabel">SENSAÇÃO</div>
                  </div>
                  <div class="mVal" id="feels">--°</div>
                </div>

                <div class="mCard">
                  <div class="mLeft">
                    <div class="mIcon" aria-hidden="true" id="icWind"></div>
                    <div class="mLabel">VENTO</div>
                  </div>
                  <div class="mVal" id="wind">-- km/h</div>
                </div>

                <div class="mCard">
                  <div class="mLeft">
                    <div class="mIcon" aria-hidden="true" id="icHum"></div>
                    <div class="mLabel">UMIDADE</div>
                  </div>
                  <div class="mVal" id="humidity">--%</div>
                </div>
              </div>
            </div>
          </section>

          <!-- DIREITA: Alterna -->
          <aside class="side">
            <div class="sideHeader">
              <div class="label" id="sideLabel">PRÓXIMOS DIAS</div>
              <div class="toggleDots" aria-hidden="true">
                <div class="tdot active" id="dotA"></div>
                <div class="tdot" id="dotB"></div>
              </div>
            </div>

            <div class="slot">
              <!-- View A: Próximos dias -->
              <div class="view active" id="viewA">
                <div class="forecastList" id="forecastList"></div>
              </div>

              <!-- View B: Detalhes hoje -->
              <div class="view" id="viewB">
                <div class="detailCard">
                  <div class="bigMinMax">
                    <div class="mmBlock">
                      <div class="mmNum" id="tMax">--°</div>
                      <div class="mmLbl">máx</div>
                    </div>
                    <div class="mmBlock">
                      <div class="mmNum" id="tMin">--°</div>
                      <div class="mmLbl">mín</div>
                    </div>
                  </div>

                  <div class="detailPills">
                    <div class="dPill" id="pillRain"><span id="rainMm">-- mm</span></div>
                    <div class="dPill" id="pillPop"><span id="popPct">--% chuva</span></div>
                    <div class="dPill" id="pillCond"><span id="condTxt">—</span></div>
                  </div>
                </div>
              </div>
            </div>
          </aside>

        </div>
      </main>

      <footer class="pvFooter" aria-label="Rodapé PontoView">
        <div class="pvFooterLeft" id="footUpdated">ATUALIZADO • —</div>
        <div class="pvFooterRight">
          <img class="pvLogo" src="./assets/logo-pontoview.png" alt="Logo PontoView" />
        </div>
      </footer>

    </div>
  </div>

  <script>
    /* =========================================================
       CONFIG
       ========================================================= */
    const FALLBACK_CITY = { name: "Vitória • ES", lat: -20.3155, lon: -40.3128, state: "ES" };
    const ROTATE_MS = 11000;
    const WEATHER_REFRESH_MIN = 25;
    const TZ = "America/Sao_Paulo";

    const GEO_TTL_HOURS = 72;
    const GEO_TIMEOUT_MS = 3500;

    const FIXED_CITY = null; // opcional

    // frio <= 19°C (pedido)
    const FEEL_LIMITS = { cold: 19, coldExtreme: 12, hot: 32, hotExtreme: 36 };

    let CITY = { ...FALLBACK_CITY };
    let dailyData = null;

    function pad2(n){ return String(n).padStart(2,"0"); }
    function hhmm(d=new Date()){ return pad2(d.getHours())+":"+pad2(d.getMinutes()); }
    function ddmm_hhmm(d=new Date()){
      const dd = pad2(d.getDate());
      const mm = pad2(d.getMonth()+1);
      return `${dd}/${mm}, ${hhmm(d)}`;
    }

    const panel = document.getElementById("panel");
    document.getElementById("title").textContent = panel.dataset.title || "PREVISÃO DO TEMPO";
    document.getElementById("subtitle").textContent = panel.dataset.subtitle || "LOCAL • ES";

    function tickClock(){ document.getElementById("pvClock").textContent = hhmm(); }
    tickClock();
    setInterval(tickClock, 1000);

    /* ===== SVGs ===== */
    function svgCloud(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 17.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 10.2 3.8 3.8 0 0 0 7 17.5h13z"/>
      </svg>`; }
    function svgSun(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="4"></circle>
        <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
      </svg>`; }
    function svgRain(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h13z"/>
        <path d="M8 19l-1 2"></path>
        <path d="M12 19l-1 2"></path>
        <path d="M16 19l-1 2"></path>
      </svg>`; }
    function svgStorm(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h9"/>
        <path d="M13 14l-2 4h3l-2 4"></path>
      </svg>`; }
    function svgPartly(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="8" cy="8" r="3"></circle>
        <path d="M8 2v1M8 13v1M2 8h1M13 8h1M3.5 3.5l.7.7M11.8 11.8l.7.7M3.5 12.5l.7-.7M11.8 4.2l.7-.7"></path>
        <path d="M20 17.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 8.3 10.1 3.8 3.8 0 0 0 9 17.5h11z"/>
      </svg>`; }
    function svgWind(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12h11"/>
        <path d="M14 12a3 3 0 1 0-3-3"/>
        <path d="M3 18h15"/>
        <path d="M18 18a3 3 0 1 0-3-3"/>
      </svg>`; }
    function svgDrop(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2s6 7 6 12a6 6 0 0 1-12 0c0-5 6-12 6-12z"/>
      </svg>`; }
    function svgThermo(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 14.76V5a2 2 0 0 0-4 0v9.76a4 4 0 1 0 4 0z"/>
      </svg>`; }
    function svgWarn(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10.3 3.2 1.8 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.2a2 2 0 0 0-3.4 0z"/>
        <path d="M12 9v4"/>
        <path d="M12 17h.01"/>
      </svg>`; }

    document.getElementById("hdrIcon").innerHTML = svgCloud();
    document.getElementById("icFeel").innerHTML = svgThermo();
    document.getElementById("icWind").innerHTML = svgWind();
    document.getElementById("icHum").innerHTML = svgDrop();

    function codeToMeta(code){
      if (code === 0) return { icon: svgSun(), text: "Ensolarado", kind:"sun" };
      if (code === 1 || code === 2) return { icon: svgPartly(), text: "Parcialmente nublado", kind:"partly" };
      if (code === 3) return { icon: svgCloud(), text: "Nublado", kind:"cloud" };
      if ([45,48].includes(code)) return { icon: svgCloud(), text: "Neblina", kind:"cloud" };
      if ([51,53,55,61,63,65,80,81,82].includes(code)) return { icon: svgRain(), text: "Chuva", kind:"rain" };
      if ([95,96,99].includes(code)) return { icon: svgStorm(), text: "Tempestade", kind:"storm" };
      return { icon: svgCloud(), text: "Tempo", kind:"cloud" };
    }

    function buildAnimatedTodayIcon(kind){
      if (kind === "rain"){
        return `
          <svg class="animFloat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h13z"/>
            <path class="animRainDrop" d="M8 19l-1 2"></path>
            <path class="animRainDrop" style="animation-delay:.2s" d="M12 19l-1 2"></path>
            <path class="animRainDrop" style="animation-delay:.4s" d="M16 19l-1 2"></path>
          </svg>
        `;
      }
      if (kind === "storm"){
        return `
          <svg class="animFloat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h9"/>
            <path class="animLightning" d="M13 14l-2 4h3l-2 4"></path>
          </svg>
        `;
      }
      if (kind === "sun") return `<div class="animFloat">${svgSun()}</div>`;
      if (kind === "partly") return `<div class="animFloat">${svgPartly()}</div>`;
      return `<div class="animFloat">${svgCloud()}</div>`;
    }

    function dowPT(dateStr){
      const d = new Date(dateStr + "T12:00:00");
      const map = ["DOM","SEG","TER","QUA","QUI","SEX","SÁB"];
      return map[d.getDay()];
    }

    /* ===== ALERTA ===== */
    function getAlertFor(code){
      if ([95,96,99].includes(code)) return { show:true, label:"ALERTA • TEMPESTADE" };
      if ([65,82].includes(code)) return { show:true, label:"ALERTA • CHUVA FORTE" };
      return { show:false, label:"" };
    }
    function setAlert(code){
      const a = getAlertFor(code);
      const top = document.getElementById("alertTop");
      const topText = document.getElementById("alertTopText");
      const icon = document.getElementById("alertIcon");

      if (a.show){
        top.classList.add("show");
        icon.innerHTML = svgWarn();
        topText.textContent = a.label;
      } else {
        top.classList.remove("show");
        icon.innerHTML = "";
        topText.textContent = "ALERTA • —";
      }
    }

    /* ===== SENSAÇÃO: aplica classes no #icFeel ===== */
    function setFeelIconState(feelsLike){
      const el = document.getElementById("icFeel");
      const v = Number(feelsLike);
      if(!el || !Number.isFinite(v)) return;

      el.classList.remove("feel-hot","feel-cold","feel-hot-extreme","feel-cold-extreme");

      if (v <= FEEL_LIMITS.cold){
        el.classList.add("feel-cold");
        if (v <= FEEL_LIMITS.coldExtreme) el.classList.add("feel-cold-extreme");
        return;
      }
      if (v >= FEEL_LIMITS.hot){
        el.classList.add("feel-hot");
        if (v >= FEEL_LIMITS.hotExtreme) el.classList.add("feel-hot-extreme");
      }
    }

    /* ===== GEO IP (sem permissão) ===== */
    function setSubtitleFromState(state){
      const sub = state ? `LOCAL • ${state}` : "LOCAL";
      document.getElementById("subtitle").textContent = sub;
    }
    function loadGeoCache(){
      try{
        const raw = localStorage.getItem("pv_geo");
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !Number.isFinite(obj.lat) || !Number.isFinite(obj.lon)) return null;
        const ageMs = Date.now() - (obj.ts || 0);
        const ttlMs = GEO_TTL_HOURS * 3600 * 1000;
        if(ageMs > ttlMs) return null;
        return obj;
      }catch(_){ return null; }
    }
    function saveGeoCache(payload){
      try{ localStorage.setItem("pv_geo", JSON.stringify({ ...payload, ts: Date.now() })); }catch(_){}
    }
    function buildCityName(city, region){
      const c = (city || "").trim();
      const r = (region || "").trim();
      if(c && r) return `${c} • ${r}`;
      if(c) return c;
      if(r) return `LOCAL • ${r}`;
      return "LOCAL";
    }
    function withTimeout(promise, ms){
      return new Promise((resolve, reject)=>{
        const t = setTimeout(()=>reject(new Error("timeout")), ms);
        promise.then(v=>{ clearTimeout(t); resolve(v); }).catch(e=>{ clearTimeout(t); reject(e); });
      });
    }
    async function fetchIPGeoProviders(){
      const providers = [
        async ()=> {
          const r = await fetch("https://ipapi.co/json/", { cache:"no-store" });
          if(!r.ok) throw new Error("ipapi");
          const j = await r.json();
          return { city:(j.city||"").trim(), region:(j.region_code||j.region||"").trim(), lat:Number(j.latitude), lon:Number(j.longitude) };
        },
        async ()=> {
          const r = await fetch("https://ipwho.is/", { cache:"no-store" });
          if(!r.ok) throw new Error("ipwhois");
          const j = await r.json();
          if(j.success === false) throw new Error("ipwhois");
          return { city:(j.city||"").trim(), region:(j.region_code||j.region||"").trim(), lat:Number(j.latitude), lon:Number(j.longitude) };
        },
        async ()=> {
          const r = await fetch("https://ip-api.com/json/?fields=status,city,region,regionName,lat,lon", { cache:"no-store" });
          if(!r.ok) throw new Error("ip-api");
          const j = await r.json();
          if(j.status !== "success") throw new Error("ip-api");
          return { city:(j.city||"").trim(), region:(j.region||j.regionName||"").trim(), lat:Number(j.lat), lon:Number(j.lon) };
        }
      ];

      const settled = await Promise.allSettled(providers.map(fn => withTimeout(fn(), GEO_TIMEOUT_MS)));
      const good = settled
        .filter(r => r.status === "fulfilled")
        .map(r => r.value)
        .filter(v => Number.isFinite(v.lat) && Number.isFinite(v.lon));

      if(!good.length) throw new Error("no-geo");

      good.sort((a,b)=>{
        const sa = (a.city?1:0) + (a.region?1:0);
        const sb = (b.city?1:0) + (b.region?1:0);
        return sb - sa;
      });

      return good[0];
    }
    function chooseBetter(oldGeo, newGeo){
      if(!oldGeo) return newGeo;
      const oldScore = (oldGeo.city?1:0) + (oldGeo.region?1:0);
      const newScore = (newGeo.city?1:0) + (newGeo.region?1:0);
      if(newScore < oldScore) return oldGeo;

      const dx = (Number(oldGeo.lat) - Number(newGeo.lat));
      const dy = (Number(oldGeo.lon) - Number(newGeo.lon));
      const dist2 = dx*dx + dy*dy;
      if(dist2 > 4 && newScore === oldScore) return oldGeo;

      return newGeo;
    }
    async function resolveCityByIP(){
      if (FIXED_CITY && Number.isFinite(FIXED_CITY.lat) && Number.isFinite(FIXED_CITY.lon)){
        CITY = { ...FIXED_CITY };
        document.getElementById("subtitle").textContent = CITY.state ? `LOCAL • ${CITY.state}` : "LOCAL";
        return;
      }

      const cached = loadGeoCache();
      if(cached){
        CITY = { name: buildCityName(cached.city, cached.region), lat:Number(cached.lat), lon:Number(cached.lon), state:(cached.region||"").trim() };
        setSubtitleFromState(CITY.state);
      }

      try{
        const g = await fetchIPGeoProviders();
        const best = chooseBetter(cached, g);
        saveGeoCache(best);

        CITY = { name: buildCityName(best.city, best.region), lat:Number(best.lat), lon:Number(best.lon), state:(best.region||"").trim() };
        setSubtitleFromState(CITY.state);
      }catch(_){
        if(!cached){
          CITY = { ...FALLBACK_CITY };
          document.getElementById("subtitle").textContent = "LOCAL • ES";
        }
      }
    }

    /* ===== AUTO-SCROLL (loop) ===== */
    let autoScrollTimer = null;
    function startAutoScrollIfNeeded(){
      const list = document.getElementById("forecastList");
      if (!list) return;

      if (autoScrollTimer) {
        clearInterval(autoScrollTimer);
        autoScrollTimer = null;
      }

      setTimeout(()=>{
        const needs = list.scrollHeight > (list.clientHeight + 2);
        if (!needs) { list.scrollTop = 0; return; }

        let direction = 1;
        const speed = 0.35;
        const pauseAtEndsMs = 900;

        autoScrollTimer = setInterval(()=>{
          const maxScroll = list.scrollHeight - list.clientHeight;
          if (maxScroll <= 0) { list.scrollTop = 0; return; }

          list.scrollTop += direction * speed;

          if (list.scrollTop >= maxScroll - 1){
            list.scrollTop = maxScroll;
            direction = -1;
            clearInterval(autoScrollTimer);
            autoScrollTimer = setTimeout(()=>startAutoScrollIfNeeded(), pauseAtEndsMs);
          } else if (list.scrollTop <= 1 && direction === -1){
            list.scrollTop = 0;
            direction = 1;
            clearInterval(autoScrollTimer);
            autoScrollTimer = setTimeout(()=>startAutoScrollIfNeeded(), pauseAtEndsMs);
          }
        }, 18);
      }, 250);
    }

    /* ===== Alternância de views (direita) ===== */
    const viewA = document.getElementById("viewA");
    const viewB = document.getElementById("viewB");
    const dotA = document.getElementById("dotA");
    const dotB = document.getElementById("dotB");
    const sideLabel = document.getElementById("sideLabel");

    let showingA = true;

    function showA(){
      showingA = true;
      viewA.classList.add("active");
      viewB.classList.remove("active");
      dotA.classList.add("active");
      dotB.classList.remove("active");
      sideLabel.textContent = "PRÓXIMOS DIAS";
      startAutoScrollIfNeeded();
    }
    function showB(){
      showingA = false;
      viewB.classList.add("active");
      viewA.classList.remove("active");
      dotB.classList.add("active");
      dotA.classList.remove("active");
      sideLabel.textContent = "DETALHES • HOJE";
    }
    setInterval(()=>{ showingA ? showB() : showA(); }, ROTATE_MS);

    /* ===== RENDER ===== */
    function renderForecastList(){
      const list = document.getElementById("forecastList");
      list.innerHTML = "";
      if(!dailyData) return;

      const { time, weather_code, temperature_2m_max, temperature_2m_min, precipitation_probability_max, precipitation_sum } = dailyData;

      const start = 1;
      const end = Math.min(time.length, 6);

      for(let i=start; i<end; i++){
        const meta = codeToMeta(weather_code[i]);
        const pop = precipitation_probability_max?.[i] ?? 0;
        const mm = (precipitation_sum?.[i] ?? 0);
        const max = Math.round(temperature_2m_max[i]);
        const min = Math.round(temperature_2m_min[i]);

        const row = document.createElement("div");
        row.className = "fRow";
        row.innerHTML = `
          <div class="fDow">${dowPT(time[i])}</div>
          <div class="fIcon" aria-hidden="true">${meta.icon}</div>
          <div class="fMid">
            <div class="fBadge">${meta.text}</div>
            <div class="fSub">${Math.round(mm*10)/10} mm • ${pop}%</div>
          </div>
          <div class="fTemps">
            <span class="pill">
              <span class="pillTag">MÁX</span>
              <span class="pillTemp">${max}°</span>
            </span>
            <span class="pill" style="opacity:.75">
              <span class="pillTag">MÍN</span>
              <span class="pillTemp">${min}°</span>
            </span>
          </div>
        `;
        list.appendChild(row);
      }

      if (showingA) startAutoScrollIfNeeded();
    }

    function renderTodayDetails(){
      if(!dailyData) return;

      const { weather_code, temperature_2m_max, temperature_2m_min, precipitation_probability_max, precipitation_sum } = dailyData;

      const idx = 0;
      const meta = codeToMeta(weather_code[idx]);
      const pop = precipitation_probability_max?.[idx] ?? 0;
      const mm = (precipitation_sum?.[idx] ?? 0);
      const max = Math.round(temperature_2m_max[idx]);
      const min = Math.round(temperature_2m_min[idx]);

      document.getElementById("tMax").textContent = `${max}°`;
      document.getElementById("tMin").textContent = `${min}°`;

      document.getElementById("pillCond").innerHTML = `${meta.icon}<span id="condTxt">${meta.text.toUpperCase()}</span>`;
      document.getElementById("pillRain").innerHTML = `${svgRain()}<span id="rainMm">${Math.round(mm*10)/10} mm</span>`;
      document.getElementById("pillPop").innerHTML = `${svgDrop()}<span id="popPct">${Math.round(pop)}% chuva</span>`;
    }

    async function loadWeather(){
      const url = new URL("https://api.open-meteo.com/v1/forecast");
      url.searchParams.set("latitude", CITY.lat);
      url.searchParams.set("longitude", CITY.lon);
      url.searchParams.set("timezone", TZ);
      url.searchParams.set("current", "temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m");
      url.searchParams.set("daily", "weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum");
      url.searchParams.set("forecast_days", "6");

      const res = await fetch(url.toString(), { cache:"no-store" });
      if(!res.ok) throw new Error("Falha ao carregar clima");
      const data = await res.json();

      document.getElementById("cityName").textContent = CITY.name || "LOCAL";
      document.getElementById("footUpdated").textContent = `ATUALIZADO • ${ddmm_hhmm()}`;

      const cur = data.current;
      const meta = codeToMeta(cur.weather_code);

      setAlert(cur.weather_code);

      document.getElementById("tempToday").innerHTML = `${Math.round(cur.temperature_2m)}<small>°C</small>`;
      document.getElementById("descToday").textContent = meta.text.toUpperCase();
      document.getElementById("todayIcon").innerHTML = buildAnimatedTodayIcon(meta.kind);

      const feels = Math.round(cur.apparent_temperature);
      document.getElementById("feels").textContent = `${feels}°`;
      setFeelIconState(feels);

      document.getElementById("wind").textContent = `${Math.round(cur.wind_speed_10m)} km/h`;
      document.getElementById("humidity").textContent = `${Math.round(cur.relative_humidity_2m)}%`;

      dailyData = data.daily;
      renderForecastList();
      renderTodayDetails();
    }

    // boot
    showA();
    (async ()=>{
      await resolveCityByIP();

      try{ await loadWeather(); }
      catch(err){
        document.getElementById("descToday").textContent = "SEM CONEXÃO";
        document.getElementById("cityName").textContent = CITY.name || "—";
        document.getElementById("footUpdated").textContent = "ATUALIZADO • —";
        console.error(err);
      }

      setInterval(()=>loadWeather().catch(()=>{}), 1000 * 60 * WEATHER_REFRESH_MIN);
    })();
  </script>
</body>
</html>
