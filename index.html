<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PontoView • Previsão do Tempo</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg0:#081423;
      --bg1:#0a2232;

      --card:#ffffff;
      --line:#e7eef7;
      --chip:#f3f6fb;
      --muted:#6b7788;
      --ink:#0e1b2a;

      --topA:#0b2a44;
      --topB:#2c6aa3;
      --topC:#0f3d63;

      /* bordas um pouquinho maiores */
      --radius:28px;
      --shadow:0 14px 44px rgba(0,0,0,.26);

      /* 4K -> 720p */
      --t-title: clamp(18px, 1.55vw, 34px);
      --t-sub:   clamp(11px, 0.95vw, 16px);
      --t-clock: clamp(30px, 3.05vw, 64px);

      --pad: clamp(14px, 1.4vw, 26px);
      --gap: clamp(12px, 1.2vw, 20px);

      --panelSoft:#f6f9fe;

      --anim: 520ms;
      --ease: cubic-bezier(.2,.8,.2,1);

      --footerH: clamp(48px, 6vh, 80px);
      --safe: clamp(12px, 2.2vw, 32px);

      /* ALERT */
      --warnBg:#fff0c2;
      --warnInk:#5a3a00;
      --warnLine:#f2c66a;
      --warnHot:#f59e0b;

      /* FEELS */
      --feelHot:#ef4444;
      --feelCold:#3b82f6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 900px at 25% 10%, rgba(87,184,231,.22) 0%, rgba(10,46,62,0) 60%),
        radial-gradient(900px 700px at 75% 80%, rgba(52,198,208,.14) 0%, rgba(6,18,24,0) 65%),
        radial-gradient(1400px 1100px at 50% 55%, var(--bg1) 0%, var(--bg0) 62%, #040a0f 100%);
      overflow:hidden;
    }

    .pvFrame{width:100vw;height:100vh;padding:var(--safe);display:flex;}
    .pvCard{
      width:100%;height:100%;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;flex-direction:column;min-height:0;
      opacity:0;transform:translateY(10px);
      animation:pvIn 700ms cubic-bezier(.22,1,.36,1) forwards;
    }
    @keyframes pvIn{to{opacity:1;transform:translateY(0)}}

    /* HEADER */
    .pvHeader{
      position:relative;
      background:linear-gradient(180deg,var(--topB) 0%,var(--topC) 42%,var(--topA) 100%);
      color:#fff;
      padding:calc(var(--pad)*1.05);
      display:flex;justify-content:space-between;align-items:center;
      gap:var(--gap);
      flex:0 0 auto;min-width:0;
      border-bottom:1px solid rgba(255,255,255,.12);
      box-shadow:inset 0 -1px 0 rgba(255,255,255,.18);
    }
    .pvHeader::before{
      content:"";position:absolute;inset:0;pointer-events:none;
      background:
        radial-gradient(900px 120px at 50% 0%, rgba(255,255,255,.22), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,0) 42%);
      opacity:.95;
    }
    .pvHeader::after{
      content:"";position:absolute;inset:10px;
      border-radius:calc(var(--radius)-10px);
      border:1px solid rgba(255,255,255,.10);
      pointer-events:none;opacity:.45;
    }
    .pvLeft,.pvRight{position:relative;z-index:1;}
    .pvLeft{display:flex;align-items:center;gap:var(--gap);min-width:0;flex:1 1 auto;}
    .pvBadge{
      width:clamp(44px,3.4vw,64px);
      height:clamp(44px,3.4vw,64px);
      border-radius:18px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.18);
      display:grid;place-items:center;flex:0 0 auto;
    }
    .pvBadge svg{width:60%;height:60%;opacity:.95}
    .pvTitles{display:flex;flex-direction:column;gap:6px;line-height:1.05;min-width:0;}
    .pvTitle{
      margin:0;font-size:var(--t-title);font-weight:900;
      letter-spacing:.06em;text-transform:uppercase;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .pvSubtitle{
      font-size:var(--t-sub);font-weight:800;letter-spacing:.12em;
      text-transform:uppercase;opacity:.92;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .pvRight{
      text-align:right;display:flex;flex-direction:column;gap:6px;
      min-width:max-content;align-items:flex-end;padding-left:10px;white-space:nowrap;
    }
    .pvClock{
      font-size:var(--t-clock);font-weight:900;line-height:1;
      letter-spacing:.02em;font-variant-numeric:tabular-nums;
    }

    /* SUBBAR */
    .pvSubbar{
      background:var(--chip);
      border-bottom:1px solid var(--line);
      padding:calc(var(--pad)*.62) var(--pad);
      display:grid;grid-template-columns:1fr auto;
      align-items:center;gap:var(--gap);
      font-size:var(--t-sub);font-weight:900;letter-spacing:.12em;text-transform:uppercase;
      color:#1c2c41;
      flex:0 0 auto;min-width:0;
    }
    .pvSubLeft{justify-self:start;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .pvSubRight{justify-self:end;display:flex;align-items:center;justify-content:flex-end;gap:12px;min-width:0;white-space:nowrap;}
    .sourceTag{
      font-size:11px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;
      color:#3b4b62;opacity:.95;
      white-space:nowrap;padding:8px 12px;border-radius:999px;background:#fff;
      border:1px solid #e7e9ee;box-shadow:0 8px 18px rgba(0,0,0,.04);
    }

    /* ALERT */
    .alertPill{
      display:none;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      background:var(--warnBg);
      border:2px solid var(--warnLine);
      color:var(--warnInk);
      font-size:12px;font-weight:900;letter-spacing:.10em;text-transform:uppercase;
      white-space:nowrap;
      box-shadow:0 10px 24px rgba(245,158,11,.18),0 0 0 0 rgba(245,158,11,.35);
      animation:alertGlow 1.2s var(--ease) infinite;
    }
    .alertPill.show{display:inline-flex;}
    .alertPill svg{width:18px;height:18px;flex:0 0 auto;}
    .alertPulse{
      width:10px;height:10px;border-radius:999px;background:var(--warnHot);
      box-shadow:0 0 0 0 rgba(245,158,11,.45);
      animation:alertPulse 1.2s var(--ease) infinite;
    }
    @keyframes alertPulse{
      0%{box-shadow:0 0 0 0 rgba(245,158,11,.45)}
      70%{box-shadow:0 0 0 14px rgba(245,158,11,0)}
      100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}
    }
    @keyframes alertGlow{
      0%,100%{box-shadow:0 10px 24px rgba(245,158,11,.18),0 0 0 0 rgba(245,158,11,.25)}
      50%{box-shadow:0 14px 30px rgba(245,158,11,.26),0 0 0 6px rgba(245,158,11,.08)}
    }

    /* MAIN */
    .pvMain{flex:1 1 auto;min-height:0;padding:var(--pad);display:flex;overflow:hidden;}
    .layout{
      width:100%;
      display:grid;
      grid-template-columns:1.15fr 0.85fr;
      gap:var(--gap);
      align-items:stretch;
      min-height:0;
    }

    /* Responsivo 720p / portrait */
    @media (max-width: 1280px){
      :root{
        --t-title: clamp(16px, 1.6vw, 28px);
        --t-clock: clamp(26px, 3.2vw, 54px);
      }
      .tempBig{font-size: clamp(58px, 6.6vw, 120px);}
    }
    @media (max-aspect-ratio: 4/3){ .layout{grid-template-columns:1fr;} }
    @media (max-aspect-ratio: 9/16){
      .pvSubbar{grid-template-columns:1fr;gap:10px;}
      .pvSubRight{justify-self:start;flex-wrap:wrap;}
    }

    /* HOJE (ESQUERDA) */
    .todayCard{
      border:1px solid var(--line);
      border-radius:24px;
      background:#fff;
      overflow:hidden;
      display:flex;flex-direction:column;min-height:0;
    }
    .todayHead{padding:18px 18px 10px;display:flex;align-items:flex-start;justify-content:space-between;gap:12px;min-width:0;flex:0 0 auto;}
    .city{
      font-size:18px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;color:#1a2a40;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .todayCenter{padding:10px 18px 0;flex:1 1 auto;min-height:0;display:flex;align-items:center;justify-content:center;}
    .todayWrap{
      width:100%;max-width:820px;
      display:grid;
      grid-template-columns:clamp(84px, 9vw, 150px) 1fr;
      align-items:center;
      gap:clamp(12px, 1.6vw, 22px);
    }
    .todayIcon{
      width:clamp(84px, 9vw, 150px);
      height:clamp(84px, 9vw, 150px);
      display:grid;place-items:center;
      color:#0f3d63;opacity:.95;
    }
    .todayIcon svg{width:100%;height:100%}
    .tempBlock{min-width:0}
    .tempBig{
      font-size:clamp(62px, 7.0vw, 150px);
      font-weight:900;letter-spacing:-0.03em;line-height:.92;white-space:nowrap;
    }
    .tempBig small{font-size:.42em;font-weight:900;opacity:.92}
    .condLine{
      margin-top:10px;
      font-size:14px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#2a3a50;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .todayBottom{padding:14px 18px 16px;border-top:1px solid var(--line);background:#fff;flex:0 0 auto;}
    .metricsRow{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;align-items:stretch;}
    @media (max-width: 1100px){ .metricsRow{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 760px){ .metricsRow{grid-template-columns:1fr;} }

    .mCard{
      background:#f1f3f5;border:1px solid #eceff3;border-radius:16px;
      padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;min-width:0;
    }
    .mLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .mIcon{
      width:38px;height:38px;border-radius:14px;background:#fff;border:1px solid #e7e9ee;
      display:grid;place-items:center;color:#1a2a40;opacity:.9;flex:0 0 auto;
      position:relative;overflow:hidden;
    }
    .mIcon svg{width:62%;height:62%}
    .mLabel{font-size:11px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#3b4b62;white-space:nowrap;}
    .mVal{font-size:18px;font-weight:900;white-space:nowrap;color:#0e1b2a;}

    /* SENSAÇÃO TÉRMICA (vermelho/azul pulsando) */
    #icFeel.feel-hot{
      background: rgba(239,68,68,.12);
      color: var(--feelHot);
      box-shadow: 0 0 0 0 rgba(239,68,68,.35);
      animation: feelPulseHot 1.2s var(--ease) infinite;
    }
    #icFeel.feel-cold{
      background: rgba(59,130,246,.12);
      color: var(--feelCold);
      box-shadow: 0 0 0 0 rgba(59,130,246,.28);
      animation: feelPulseCold 1.3s var(--ease) infinite;
    }
    @keyframes feelPulseHot{
      0%{ box-shadow:0 0 0 0 rgba(239,68,68,.35); transform:scale(1);}
      60%{ box-shadow:0 0 0 12px rgba(239,68,68,0); transform:scale(1.03);}
      100%{ box-shadow:0 0 0 0 rgba(239,68,68,0); transform:scale(1);}
    }
    @keyframes feelPulseCold{
      0%{ box-shadow:0 0 0 0 rgba(59,130,246,.28); transform:scale(1);}
      60%{ box-shadow:0 0 0 12px rgba(59,130,246,0); transform:scale(1.03);}
      100%{ box-shadow:0 0 0 0 rgba(59,130,246,0); transform:scale(1);}
    }

    /* DIREITA */
    .side{
      border:1px solid var(--line);
      border-radius:24px;background:#fff;overflow:hidden;
      display:flex;flex-direction:column;min-height:0;
    }
    .sideHeader{
      padding:14px 16px;background:var(--panelSoft);
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex:0 0 auto;
    }
    .sideHeader .label{
      font-size:12px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#3b4b62;
      white-space:nowrap;min-width:0;overflow:hidden;text-overflow:ellipsis;
    }
    .toggleDots{display:flex;gap:8px;align-items:center;}
    .tdot{width:10px;height:10px;border-radius:999px;background:#c9d7ea;transition:all 420ms var(--ease);}
    .tdot.active{background:#2d76b9;width:22px;}
    .slot{position:relative;flex:1 1 auto;padding:16px;min-height:0;background:#fff;overflow:hidden;}
    .view{
      position:absolute;inset:16px;
      opacity:0;transform:translateY(10px);
      pointer-events:none;
      transition:opacity var(--anim) var(--ease), transform var(--anim) var(--ease);
      display:flex;flex-direction:column;gap:12px;min-height:0;
    }
    .view.active{opacity:1;transform:translateY(0);pointer-events:auto;}

    /* Próximos dias */
    .forecastList{
      display:flex;flex-direction:column;gap:12px;min-height:0;
      overflow:auto;overscroll-behavior:contain;scrollbar-width:none;
    }
    .forecastList::-webkit-scrollbar{width:0;height:0;}
    .fRow{
      background:#f1f3f5;border:1px solid #eceff3;border-radius:16px;padding:12px;
      display:grid;grid-template-columns:56px 44px 1fr auto;align-items:center;gap:12px;min-width:0;
    }
    @media (max-width: 760px){
      .fRow{grid-template-columns:56px 44px 1fr;}
      .fTemps{justify-content:flex-start;padding-top:10px;}
    }
    .fDow{font-size:14px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;color:#1a2a40;white-space:nowrap;}
    .fIcon{
      width:44px;height:44px;border-radius:14px;background:#fff;border:1px solid #e7e9ee;
      display:grid;place-items:center;color:#0f3d63;opacity:.95;flex:0 0 auto;
    }
    .fIcon svg{width:70%;height:70%}
    .fMid{min-width:0;display:flex;flex-direction:column;gap:6px;}
    .fBadge{
      display:inline-flex;align-items:center;padding:8px 12px;border-radius:999px;background:#fff;border:1px solid #e7e9ee;
      width:fit-content;max-width:100%;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-size:12px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;color:#23344a;
    }
    .fSub{font-size:11px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:#3b4b62;opacity:.92;white-space:nowrap;}
    .fTemps{display:flex;align-items:center;justify-content:flex-end;gap:10px;white-space:nowrap;font-weight:900;}
    .pill{
      position:relative;padding:10px 12px 8px;min-width:52px;border-radius:999px;background:#fff;border:1px solid #e7e9ee;
      font-size:12px;font-weight:900;color:#0e1b2a;display:inline-flex;align-items:center;justify-content:center;
    }
    .pillTag{position:absolute;top:5px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;opacity:.55;line-height:1;}
    .pillTemp{display:block;margin-top:10px;font-size:12px;font-weight:900;}

    /* Detalhes HOJE */
    .detailCard{
      border:1px solid #eef2f7;border-radius:18px;padding:14px;background:#fff;
      display:flex;flex-direction:column;gap:12px;min-height:0;
    }
    .bigMinMax{display:flex;gap:18px;align-items:flex-end;justify-content:flex-start;padding:6px 2px 4px;flex-wrap:wrap;}
    .mmBlock{display:flex;align-items:baseline;gap:10px;}
    .mmNum{font-size:clamp(40px, 3.6vw, 64px);font-weight:900;letter-spacing:-0.02em;line-height:1;color:#0e1b2a;white-space:nowrap;}
    .mmLbl{font-size:12px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:#7a8697;white-space:nowrap;}
    .detailPills{display:flex;gap:10px;flex-wrap:wrap;}
    .dPill{
      display:inline-flex;align-items:center;gap:10px;padding:10px 12px;border-radius:999px;background:#fff;border:1px solid #e7e9ee;
      box-shadow:0 8px 18px rgba(0,0,0,.04);
      font-size:12px;font-weight:900;letter-spacing:.08em;text-transform:uppercase;color:#23344a;white-space:nowrap;
    }
    .dPill svg{width:16px;height:16px;opacity:.9}

    /* FOOTER */
    .pvFooter{
      flex:0 0 auto;height:var(--footerH);
      display:flex;align-items:center;justify-content:space-between;
      padding:10px var(--pad);
      border-top:1px solid var(--line);
      background:transparent;gap:12px;min-width:0;
    }
    .pvFooterUpdate{
      font-size:11px;font-weight:900;letter-spacing:.12em;text-transform:uppercase;color:#3b4b62;opacity:.95;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .pvLogo{height:clamp(16px, 2.4vh, 22px);width:auto;display:block;opacity:.90;}

    /* ÍCONE HOJE animado */
    .animFloat{animation:floaty 2.8s var(--ease) infinite;transform-origin:50% 50%;}
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .animRainDrop{animation:drop 1.2s linear infinite;}
    @keyframes drop{0%{transform:translateY(-2px);opacity:.2}35%{opacity:1}100%{transform:translateY(10px);opacity:0}}
    .animLightning{animation:flash 1.1s var(--ease) infinite;transform-origin:50% 50%;}
    @keyframes flash{0%,60%,100%{opacity:1;transform:scale(1)}30%{opacity:.2;transform:scale(.98)}}
  </style>
</head>

<body>
  <div class="pvFrame">
    <div class="pvCard" id="panel" data-title="PREVISÃO DO TEMPO" data-subtitle="LOCAL • ES">
      <header class="pvHeader">
        <div class="pvLeft">
          <div class="pvBadge" aria-hidden="true" id="hdrIcon"></div>
          <div class="pvTitles">
            <h1 class="pvTitle" id="title"></h1>
            <div class="pvSubtitle" id="subtitle"></div>
          </div>
        </div>
        <div class="pvRight">
          <div class="pvClock" id="pvClock">--:--</div>
        </div>
      </header>

      <div class="pvSubbar">
        <div class="pvSubLeft" id="subLeft">HOJE • PRÓXIMOS DIAS</div>
        <div class="pvSubRight">
          <div class="sourceTag" id="subSource">FONTE • OPEN-METEO</div>

          <div class="alertPill" id="alertTop">
            <span class="alertPulse" aria-hidden="true"></span>
            <span id="alertIcon" aria-hidden="true"></span>
            <span id="alertTopText">ALERTA • —</span>
          </div>
        </div>
      </div>

      <main class="pvMain">
        <div class="layout">
          <section class="todayCard">
            <div class="todayHead">
              <div class="city" id="cityName">—</div>
            </div>

            <div class="todayCenter">
              <div class="todayWrap">
                <div class="todayIcon" id="todayIcon" aria-hidden="true"></div>
                <div class="tempBlock">
                  <div class="tempBig" id="tempToday">--<small>°C</small></div>
                  <div class="condLine" id="descToday">CARREGANDO…</div>
                </div>
              </div>
            </div>

            <div class="todayBottom">
              <div class="metricsRow">
                <div class="mCard">
                  <div class="mLeft">
                    <div class="mIcon" aria-hidden="true" id="icFeel"></div>
                    <div class="mLabel">SENSAÇÃO</div>
                  </div>
                  <div class="mVal" id="feels">--°</div>
                </div>

                <div class="mCard">
                  <div class="mLeft">
                    <div class="mIcon" aria-hidden="true" id="icWind"></div>
                    <div class="mLabel">VENTO</div>
                  </div>
                  <div class="mVal" id="wind">-- km/h</div>
                </div>

                <div class="mCard">
                  <div class="mLeft">
                    <div class="mIcon" aria-hidden="true" id="icHum"></div>
                    <div class="mLabel">UMIDADE</div>
                  </div>
                  <div class="mVal" id="humidity">--%</div>
                </div>
              </div>
            </div>
          </section>

          <aside class="side">
            <div class="sideHeader">
              <div class="label" id="sideLabel">PRÓXIMOS DIAS</div>
              <div class="toggleDots" aria-hidden="true">
                <div class="tdot active" id="dotA"></div>
                <div class="tdot" id="dotB"></div>
              </div>
            </div>

            <div class="slot">
              <div class="view active" id="viewA">
                <div class="forecastList" id="forecastList"></div>
              </div>

              <div class="view" id="viewB">
                <div class="detailCard">
                  <div class="bigMinMax">
                    <div class="mmBlock">
                      <div class="mmNum" id="tMax">--°</div>
                      <div class="mmLbl">máx</div>
                    </div>
                    <div class="mmBlock">
                      <div class="mmNum" id="tMin">--°</div>
                      <div class="mmLbl">mín</div>
                    </div>
                  </div>

                  <div class="detailPills">
                    <div class="dPill" id="pillRain"><span id="rainMm">-- mm</span></div>
                    <div class="dPill" id="pillPop"><span id="popPct">--% chuva</span></div>
                    <div class="dPill" id="pillCond"><span id="condTxt">—</span></div>
                  </div>
                </div>
              </div>
            </div>
          </aside>

        </div>
      </main>

      <footer class="pvFooter" aria-label="Rodapé PontoView">
        <div class="pvFooterUpdate" id="footUpdated">ATUALIZADO • —</div>
        <img class="pvLogo" src="./assets/logo-pontoview.png" alt="Logo PontoView" />
      </footer>
    </div>
  </div>

  <script>
    /* =========================================================
       CONFIG: PARA GARANTIR "CIDADE • UF" SEM DEPENDER DO DISPOSITIVO
       =========================================================

       ✅ RECOMENDADO: defina FORCE_CITY para o painel.
       Exemplo:
       const FORCE_CITY = { name:"Colatina", uf:"ES", lat:-19.5392, lon:-40.6301 };

       Se deixar null, ele tenta IP (3 serviços) + cache.
    */
    const FORCE_CITY = null; // <-- PREENCHA SE QUISER FIXAR (RECOMENDADO)

    const FALLBACK_CITY = { name:"Vitória", uf:"ES", lat:-20.3155, lon:-40.3128 };
    const ROTATE_MS = 11000;
    const WEATHER_REFRESH_MIN = 25;
    const TZ = "America/Sao_Paulo";

    const FEEL_COLD = 19;  // <= 19°C
    const FEEL_HOT  = 32;  // >= 32°C

    const CITY_CACHE_KEY = "pv_city_cityuf_cache_v3";

    let CITY = { ...FALLBACK_CITY };
    let dailyData = null;

    function pad2(n){ return String(n).padStart(2,"0"); }
    function hhmm(d=new Date()){ return pad2(d.getHours())+":"+pad2(d.getMinutes()); }
    function ddmm_hhmm(d=new Date()){
      const dd = pad2(d.getDate());
      const mm = pad2(d.getMonth()+1);
      return `${dd}/${mm}, ${hhmm(d)}`;
    }

    const panel = document.getElementById("panel");
    document.getElementById("title").textContent = panel.dataset.title || "PREVISÃO DO TEMPO";

    function tickClock(){ document.getElementById("pvClock").textContent = hhmm(); }
    tickClock();
    setInterval(tickClock, 1000);

    /* ===== SVGs ===== */
    function svgCloud(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 17.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 10.2 3.8 3.8 0 0 0 7 17.5h13z"/>
      </svg>`; }
    function svgSun(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="4"></circle>
        <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
      </svg>`; }
    function svgMoon(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.8A8.5 8.5 0 0 1 11.2 3a6.5 6.5 0 1 0 9.8 9.8z"></path>
      </svg>`; }
    function svgRain(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h13z"/>
        <path d="M8 19l-1 2"></path>
        <path d="M12 19l-1 2"></path>
        <path d="M16 19l-1 2"></path>
      </svg>`; }
    function svgStorm(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h9"/>
        <path d="M13 14l-2 4h3l-2 4"></path>
      </svg>`; }
    function svgPartly(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="8" cy="8" r="3"></circle>
        <path d="M8 2v1M8 13v1M2 8h1M13 8h1M3.5 3.5l.7.7M11.8 11.8l.7.7M3.5 12.5l.7-.7M11.8 4.2l.7-.7"></path>
        <path d="M20 17.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 8.3 10.1 3.8 3.8 0 0 0 9 17.5h11z"/>
      </svg>`; }
    function svgWind(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12h11"/>
        <path d="M14 12a3 3 0 1 0-3-3"/>
        <path d="M3 18h15"/>
        <path d="M18 18a3 3 0 1 0-3-3"/>
      </svg>`; }
    function svgDrop(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2s6 7 6 12a6 6 0 0 1-12 0c0-5 6-12 6-12z"/>
      </svg>`; }
    function svgThermo(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 14.76V5a2 2 0 0 0-4 0v9.76a4 4 0 1 0 4 0z"/>
      </svg>`; }
    function svgWarn(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10.3 3.2 1.8 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.2a2 2 0 0 0-3.4 0z"/>
        <path d="M12 9v4"/>
        <path d="M12 17h.01"/>
      </svg>`; }

    document.getElementById("icFeel").innerHTML = svgThermo();
    document.getElementById("icWind").innerHTML = svgWind();
    document.getElementById("icHum").innerHTML = svgDrop();

    function isNight(){
      const h = new Date().getHours();
      return (h >= 18 || h < 6);
    }

    function codeToMeta(code){
      if (code === 0) return { icon: isNight() ? svgMoon() : svgSun(), text: isNight() ? "Noite limpa" : "Ensolarado", kind: isNight() ? "moon" : "sun" };
      if (code === 1 || code === 2) return { icon: svgPartly(), text: "Parcialmente nublado", kind:"partly" };
      if (code === 3) return { icon: svgCloud(), text: "Nublado", kind:"cloud" };
      if ([45,48].includes(code)) return { icon: svgCloud(), text: "Neblina", kind:"cloud" };
      if ([51,53,55,61,63,65,80,81,82].includes(code)) return { icon: svgRain(), text: "Chuva", kind:"rain" };
      if ([95,96,99].includes(code)) return { icon: svgStorm(), text: "Tempestade", kind:"storm" };
      return { icon: svgCloud(), text: "Tempo", kind:"cloud" };
    }

    function buildAnimatedTodayIcon(kind){
      if (kind === "rain"){
        return `
          <svg class="animFloat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h13z"/>
            <path class="animRainDrop" d="M8 19l-1 2"></path>
            <path class="animRainDrop" style="animation-delay:.2s" d="M12 19l-1 2"></path>
            <path class="animRainDrop" style="animation-delay:.4s" d="M16 19l-1 2"></path>
          </svg>
        `;
      }
      if (kind === "storm"){
        return `
          <svg class="animFloat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h9"/>
            <path class="animLightning" d="M13 14l-2 4h3l-2 4"></path>
          </svg>
        `;
      }
      if (kind === "sun") return `<div class="animFloat">${svgSun()}</div>`;
      if (kind === "moon") return `<div class="animFloat">${svgMoon()}</div>`;
      if (kind === "partly") return `<div class="animFloat">${svgPartly()}</div>`;
      return `<div class="animFloat">${svgCloud()}</div>`;
    }

    function dowPT(dateStr){
      const d = new Date(dateStr + "T12:00:00");
      const map = ["DOM","SEG","TER","QUA","QUI","SEX","SÁB"];
      return map[d.getDay()];
    }

    /* ALERTA */
    function getAlertFor(code){
      if ([95,96,99].includes(code)) return { show:true, label:"ALERTA • TEMPESTADE" };
      if ([65,82].includes(code)) return { show:true, label:"ALERTA • CHUVA FORTE" };
      return { show:false, label:"" };
    }
    function setAlert(code){
      const a = getAlertFor(code);
      const top = document.getElementById("alertTop");
      const topText = document.getElementById("alertTopText");
      const icon = document.getElementById("alertIcon");

      if (a.show){
        top.classList.add("show");
        icon.innerHTML = svgWarn();
        topText.textContent = a.label;
      } else {
        top.classList.remove("show");
        icon.innerHTML = "";
        topText.textContent = "ALERTA • —";
      }
    }

    /* VIEWS */
    const viewA = document.getElementById("viewA");
    const viewB = document.getElementById("viewB");
    const dotA = document.getElementById("dotA");
    const dotB = document.getElementById("dotB");
    const sideLabel = document.getElementById("sideLabel");
    let showingA = true;

    function showA(){
      showingA = true;
      viewA.classList.add("active");
      viewB.classList.remove("active");
      dotA.classList.add("active");
      dotB.classList.remove("active");
      sideLabel.textContent = "PRÓXIMOS DIAS";
      startAutoScrollIfNeeded();
    }
    function showB(){
      showingA = false;
      stopAutoScroll();
      viewB.classList.add("active");
      viewA.classList.remove("active");
      dotB.classList.add("active");
      dotA.classList.remove("active");
      sideLabel.textContent = "DETALHES • HOJE";
    }
    setInterval(()=>{ showingA ? showB() : showA(); }, ROTATE_MS);

    /* AUTO-SCROLL ping-pong suave */
    let autoScrollRAF = null;
    let autoScrollCancel = { on:false };

    function stopAutoScroll(){
      autoScrollCancel.on = true;
      if (autoScrollRAF) cancelAnimationFrame(autoScrollRAF);
      autoScrollRAF = null;
    }
    function easeInOutCubic(t){
      return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3)/2;
    }
    function animateScroll(el, to, durationMs){
      return new Promise(resolve=>{
        const start = el.scrollTop;
        const delta = to - start;
        const t0 = performance.now();

        function step(ts){
          if (autoScrollCancel.on) return resolve();
          const p = Math.min(1, (ts - t0) / durationMs);
          el.scrollTop = start + delta * easeInOutCubic(p);
          if (p < 1) autoScrollRAF = requestAnimationFrame(step);
          else resolve();
        }
        autoScrollRAF = requestAnimationFrame(step);
      });
    }

    function startAutoScrollIfNeeded(){
      const list = document.getElementById("forecastList");
      if (!list) return;

      stopAutoScroll();
      autoScrollCancel = { on:false };

      setTimeout(async ()=>{
        if (autoScrollCancel.on) return;

        const maxScroll = list.scrollHeight - list.clientHeight;
        if (maxScroll <= 2){
          list.scrollTop = 0;
          return;
        }

        const downMs = 9000;
        const upMs   = 7000;
        const pauseTopMs = 700;
        const pauseEndMs = 900;

        async function loop(){
          if (autoScrollCancel.on) return;

          await new Promise(r=>setTimeout(r, pauseTopMs));
          if (autoScrollCancel.on) return;

          const end = list.scrollHeight - list.clientHeight;
          if (end <= 2){ list.scrollTop = 0; return; }

          await animateScroll(list, end, downMs);
          if (autoScrollCancel.on) return;

          await new Promise(r=>setTimeout(r, pauseEndMs));
          if (autoScrollCancel.on) return;

          await animateScroll(list, 0, upMs);
          if (autoScrollCancel.on) return;

          loop();
        }
        loop();
      }, 250);
    }

    /* Render */
    function renderForecastList(){
      const list = document.getElementById("forecastList");
      list.innerHTML = "";
      if(!dailyData) return;

      const { time, weather_code, temperature_2m_max, temperature_2m_min, precipitation_probability_max, precipitation_sum } = dailyData;

      for(let i=1; i<Math.min(time.length, 6); i++){
        const meta = codeToMeta(weather_code[i]);
        const pop = precipitation_probability_max?.[i] ?? 0;
        const mm = (precipitation_sum?.[i] ?? 0);
        const max = Math.round(temperature_2m_max[i]);
        const min = Math.round(temperature_2m_min[i]);

        const row = document.createElement("div");
        row.className = "fRow";
        row.innerHTML = `
          <div class="fDow">${dowPT(time[i])}</div>
          <div class="fIcon" aria-hidden="true">${meta.icon}</div>
          <div class="fMid">
            <div class="fBadge">${meta.text}</div>
            <div class="fSub">${Math.round(mm*10)/10} mm • ${pop}%</div>
          </div>
          <div class="fTemps">
            <span class="pill">
              <span class="pillTag">MÁX</span>
              <span class="pillTemp">${max}°</span>
            </span>
            <span class="pill" style="opacity:.75">
              <span class="pillTag">MÍN</span>
              <span class="pillTemp">${min}°</span>
            </span>
          </div>
        `;
        list.appendChild(row);
      }

      if (showingA) startAutoScrollIfNeeded();
    }

    function renderTodayDetails(){
      if(!dailyData) return;

      const { weather_code, temperature_2m_max, temperature_2m_min, precipitation_probability_max, precipitation_sum } = dailyData;

      const idx = 0;
      const meta = codeToMeta(weather_code[idx]);
      const pop = precipitation_probability_max?.[idx] ?? 0;
      const mm = (precipitation_sum?.[idx] ?? 0);
      const max = Math.round(temperature_2m_max[idx]);
      const min = Math.round(temperature_2m_min[idx]);

      document.getElementById("tMax").textContent = `${max}°`;
      document.getElementById("tMin").textContent = `${min}°`;

      document.getElementById("pillCond").innerHTML = `${meta.icon}<span id="condTxt">${meta.text.toUpperCase()}</span>`;
      document.getElementById("pillRain").innerHTML = `${svgRain()}<span id="rainMm">${Math.round(mm*10)/10} mm</span>`;
      document.getElementById("pillPop").innerHTML = `${svgDrop()}<span id="popPct">${Math.round(pop)}% chuva</span>`;
    }

    function setFeelsIconState(apparent){
      const ic = document.getElementById("icFeel");
      ic.classList.remove("feel-hot","feel-cold");

      if (apparent >= FEEL_HOT) ic.classList.add("feel-hot");
      else if (apparent <= FEEL_COLD) ic.classList.add("feel-cold");
    }

    function formatCityUF(name, uf){
      const n = (name || "").trim();
      const u = (uf || "").trim().toUpperCase();
      if (n && u) return `${n} • ${u}`;
      if (n) return n;
      return "LOCAL";
    }

    function saveCityCache(obj){
      try{ localStorage.setItem(CITY_CACHE_KEY, JSON.stringify({ t: Date.now(), city: obj })); }catch(e){}
    }
    function loadCityCache(){
      try{
        const raw = localStorage.getItem(CITY_CACHE_KEY);
        if (!raw) return null;
        const j = JSON.parse(raw);
        return j?.city || null;
      }catch(e){ return null; }
    }

    async function tryProvider(url, parser){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("provider fail");
      const data = await res.json();
      return parser(data);
    }

    async function resolveCity(){
      // 1) FORÇADO (garante CIDADE-UF)
      if (FORCE_CITY && FORCE_CITY.lat && FORCE_CITY.lon){
        CITY = {
          name: FORCE_CITY.name,
          uf: FORCE_CITY.uf,
          lat: FORCE_CITY.lat,
          lon: FORCE_CITY.lon
        };
        saveCityCache(CITY);
        return;
      }

      // 2) CACHE
      const cached = loadCityCache();
      if (cached?.lat && cached?.lon && cached?.name && cached?.uf){
        CITY = cached;
        return;
      }

      // 3) IP providers (cascata)
      const providers = [
        async ()=> tryProvider("https://ipapi.co/json/", (j)=>({
          name: (j.city||"").trim(),
          uf: (j.region_code || j.region || "").trim().toUpperCase(),
          lat: Number(j.latitude),
          lon: Number(j.longitude)
        })),
        async ()=> tryProvider("https://ipwho.is/", (j)=>({
          name: (j.city||"").trim(),
          uf: (j.region_code || j.region || "").trim().toUpperCase(),
          lat: Number(j.latitude),
          lon: Number(j.longitude)
        })),
        async ()=> tryProvider("https://ipinfo.io/json", (j)=>{ // loc: "lat,lon"
          const loc = (j.loc||"").split(",");
          return {
            name: (j.city||"").trim(),
            uf: (j.region||"").trim().toUpperCase(),
            lat: Number(loc[0]),
            lon: Number(loc[1])
          };
        }),
      ];

      for (const fn of providers){
        try{
          const got = await fn();
          if (got && got.name && got.uf && Number.isFinite(got.lat) && Number.isFinite(got.lon)){
            CITY = got;
            saveCityCache(CITY);
            return;
          }
        }catch(e){}
      }

      // 4) fallback
      CITY = { ...FALLBACK_CITY };
      saveCityCache(CITY);
    }

    async function loadWeather(){
      const url = new URL("https://api.open-meteo.com/v1/forecast");
      url.searchParams.set("latitude", CITY.lat);
      url.searchParams.set("longitude", CITY.lon);
      url.searchParams.set("timezone", TZ);
      url.searchParams.set("current", "temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m");
      url.searchParams.set("daily", "weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum");
      url.searchParams.set("forecast_days", "6");

      const res = await fetch(url.toString(), { cache:"no-store" });
      if(!res.ok) throw new Error("Falha ao carregar clima");
      const data = await res.json();

      const cityUF = formatCityUF(CITY.name, CITY.uf);
      document.getElementById("cityName").textContent = cityUF;
      document.getElementById("subtitle").textContent = cityUF;
      document.getElementById("footUpdated").textContent = `ATUALIZADO • ${ddmm_hhmm()}`;

      const cur = data.current;
      const meta = codeToMeta(cur.weather_code);

      document.getElementById("hdrIcon").innerHTML = meta.icon;
      setAlert(cur.weather_code);

      document.getElementById("tempToday").innerHTML = `${Math.round(cur.temperature_2m)}<small>°C</small>`;
      document.getElementById("descToday").textContent = meta.text.toUpperCase();
      document.getElementById("todayIcon").innerHTML = buildAnimatedTodayIcon(meta.kind);

      document.getElementById("feels").textContent = `${Math.round(cur.apparent_temperature)}°`;
      document.getElementById("wind").textContent = `${Math.round(cur.wind_speed_10m)} km/h`;
      document.getElementById("humidity").textContent = `${Math.round(cur.relative_humidity_2m)}%`;

      setFeelsIconState(Math.round(cur.apparent_temperature));

      dailyData = data.daily;
      renderForecastList();
      renderTodayDetails();
    }

    // BOOT
    showA();
    (async ()=>{
      try{
        await resolveCity();
      }catch(e){
        CITY = { ...FALLBACK_CITY };
      }

      try{
        await loadWeather();
      }catch(err){
        console.error("ERRO painel clima:", err);
        const cityUF = formatCityUF(CITY.name, CITY.uf);
        document.getElementById("subtitle").textContent = cityUF;
        document.getElementById("cityName").textContent = cityUF;
        document.getElementById("descToday").textContent = "SEM CONEXÃO";
        document.getElementById("footUpdated").textContent = "ATUALIZADO • —";
      }

      setInterval(()=>loadWeather().catch(()=>{}), 1000 * 60 * WEATHER_REFRESH_MIN);
    })();
  </script>
</body>
</html>
