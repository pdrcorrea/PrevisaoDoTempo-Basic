<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PontoView • Previsão do Tempo</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800;900&display=swap" rel="stylesheet"/>
  <!-- Material Symbols (Google Fonts) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,600,0,0" />

  <style>
    :root{
      --ink:#0b1626;

      --topA:#0b2a44;
      --topB:#2c6aa3;
      --topC:#0f3d63;

      --pad: clamp(14px, 1.8vw, 26px);
      --gap: clamp(12px, 1.4vw, 18px);

      --panel:#e7edf5;
      --card: rgba(255,255,255,.78);
      --line: rgba(210,222,238,.95);

      --radius: clamp(24px, 2.2vw, 36px);
      --radiusCard: clamp(18px, 1.8vw, 28px);
      --footerH: clamp(54px, 6vh, 78px);

      --ease: cubic-bezier(.2,.8,.2,1);
      --anim: 520ms;

      --dividerGrad: linear-gradient(90deg,
        rgba(44,106,163,0) 0%,
        rgba(44,106,163,.9) 18%,
        rgba(15,61,99,.95) 50%,
        rgba(44,106,163,.9) 82%,
        rgba(44,106,163,0) 100%
      );

      --feelHot:#ef4444;
      --feelHotBg: rgba(239,68,68,.12);
      --feelHotLine: rgba(239,68,68,.24);

      --feelCold:#3b82f6;
      --feelColdBg: rgba(59,130,246,.12);
      --feelColdLine: rgba(59,130,246,.24);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:#fff;
      overflow:hidden;
    }

    .pvShell{
      width:100vw;
      height:100vh;
      display:flex;
      flex-direction:column;
      min-height:0;
      background:#fff;
    }

    /* ================= HEADER ================= */
    .pvHeader{
      position:relative;
      background: linear-gradient(180deg, var(--topB) 0%, var(--topC) 42%, var(--topA) 100%);
      color:#fff;
      padding: clamp(14px, 1.8vw, 22px) var(--pad);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:var(--gap);
      flex:0 0 auto;
      min-width:0;
      border-bottom: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 -1px 0 rgba(255,255,255,.18);
    }
    .pvHeader::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(900px 120px at 50% 0%, rgba(255,255,255,.22), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,0) 42%);
      opacity:.95;
    }

    .pvHeaderLeft, .pvHeaderRight{position:relative; z-index:1;}
    .pvHeaderLeft{
      display:flex;
      align-items:center;
      gap: clamp(12px, 1.5vw, 18px);
      min-width:0;
      flex:1 1 auto;
    }

    .pvIconBadge{
      width: clamp(44px, 4.2vw, 64px);
      height: clamp(44px, 4.2vw, 64px);
      border-radius: 18px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.24);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.20), 0 14px 28px rgba(0,0,0,.14);
      backdrop-filter: blur(10px);
      display:grid;
      place-items:center;
      flex:0 0 auto;
      color:#fff;
    }
    .pvIconBadge .material-symbols-outlined{
      font-size: 34px;
      line-height: 1;
      color:#fff;
      font-variation-settings:'FILL' 0,'wght' 650,'GRAD' 0,'opsz' 24;
      opacity:.98;
    }

    .pvTitles{display:flex; flex-direction:column; gap:6px; min-width:0;}
    .pvTitle{
      margin:0;
      font-size: clamp(18px, 2.1vw, 34px);
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      line-height:1.02;
    }

    /* (REMOVIDO) pvSubtitle abaixo do título */

    .pvHeaderRight{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      min-width:max-content;
    }
    .pvPill{
      user-select:none;
      font-size: clamp(12px, 1.1vw, 16px);
      font-weight: 900;
      letter-spacing:.10em;
      text-transform: uppercase;
      color:#fff;
      padding: clamp(10px, 1.1vw, 14px) clamp(14px, 1.5vw, 22px);
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 12px 26px rgba(0,0,0,.14);
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }

    /* ================= MAIN ================= */
    .pvMain{
      flex:1 1 auto;
      min-height:0;
      padding: var(--pad);
      display:flex;
      overflow:hidden;
      background:#fff;
    }

    .panel{
      width:100%;
      min-height:0;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(231,237,245,1), rgba(223,232,244,1));
      padding: clamp(12px, 1.4vw, 18px);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.45);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      align-items:stretch;
    }

    .card{
      border-radius: var(--radius);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      background: var(--card);
      border: 1px solid var(--line);
      box-shadow: 0 12px 26px rgba(2,10,23,.10);
      backdrop-filter: blur(7px);
    }

    /* ===== HOJE ===== */
    .todayHead{
      padding: clamp(16px, 1.8vw, 22px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      min-width:0;
      flex:0 0 auto;
    }

    /* cidade com marquee (sem fade) */
    .city{
      font-size: clamp(14px, 1.2vw, 18px);
      font-weight: 900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#1a2a40;
      white-space:nowrap;
      overflow:hidden;
      min-width:0;
      opacity:.95;
    }
    .cityText{ display:inline-block; white-space:nowrap; will-change: transform; }
    .city.is-marquee .cityText{
      animation: pvMarq var(--marqDur, 12s) linear infinite;
    }
    @keyframes pvMarq{
      0%{ transform: translateX(0); }
      10%{ transform: translateX(0); }
      90%{ transform: translateX(calc(-1 * var(--marqMove, 0px))); }
      100%{ transform: translateX(calc(-1 * var(--marqMove, 0px))); }
    }

    .todayCenter{
      padding: 0 clamp(16px, 1.8vw, 22px);
      flex:1 1 auto;
      min-height:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .todayWrap{
      width:100%;
      max-width: 860px;
      display:grid;
      grid-template-columns: clamp(96px, 10vw, 160px) 1fr;
      align-items:center;
      gap: clamp(14px, 1.8vw, 24px);
      min-width:0;
    }
    .todayIcon{
      width: clamp(96px, 10vw, 160px);
      height: clamp(96px, 10vw, 160px);
      display:grid;
      place-items:center;
      color:#0f3d63;
      opacity:.95;
    }
    .todayIcon svg{width:100%; height:100%}

    .animFloat{animation: floaty 2.8s var(--ease) infinite; transform-origin: 50% 50%;}
    @keyframes floaty{0%,100%{transform: translateY(0)}50%{transform: translateY(-6px)}}
    .animRainDrop{animation: drop 1.2s linear infinite;}
    @keyframes drop{0%{transform: translateY(-2px); opacity:.2}35%{opacity:1}100%{transform: translateY(10px); opacity:0}}
    .animLightning{animation: flash 1.1s var(--ease) infinite; transform-origin: 50% 50%;}
    @keyframes flash{0%,60%,100%{opacity:1; transform: scale(1)}30%{opacity:.2; transform: scale(.98)}}

    .tempBig{
      font-size: clamp(74px, 7.4vw, 160px);
      font-weight: 900;
      letter-spacing:-0.03em;
      line-height: .92;
      white-space:nowrap;
      color:#0e1b2a;
    }
    .tempBig small{font-size:.42em; font-weight: 900; opacity:.92}

    /* descrição com marquee (sem fade) */
    .condLine{
      margin-top: 10px;
      font-size: clamp(12px, 1.05vw, 14px);
      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#2a3a50;
      white-space:nowrap;
      overflow:hidden;
      min-width:0;
      opacity:.92;
    }
    .condText{ display:inline-block; white-space:nowrap; will-change: transform; }
    .condLine.is-marquee .condText{
      animation: pvMarq var(--marqDur, 12s) linear infinite;
    }

    .todayBottom{
      padding: clamp(14px, 1.6vw, 20px);
      flex:0 0 auto;
    }
    .metricsRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      align-items:stretch;
    }
    .mCard{
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(210,222,238,.95);
      border-radius: 18px;
      padding: 12px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap: 10px;
      min-width:0;
      backdrop-filter: blur(6px);
    }
    .mLeft{ display:flex; align-items:center; gap:10px; min-width:0; overflow:hidden; }
    .mIcon{
      width:34px; height:34px;
      border-radius: 12px;
      background: rgba(255,255,255,.86);
      border:1px solid rgba(210,222,238,.95);
      display:grid; place-items:center;
      color:#1a2a40;
      opacity:.92;
      flex:0 0 auto;
      overflow:hidden;
    }
    .mIcon svg{width:62%; height:62%}
    .mLabel{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#3b4b62;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .mVal{
      font-size: 18px;
      font-weight: 900;
      white-space:nowrap;
      color:#0e1b2a;
      font-variant-numeric: tabular-nums;
      justify-self:end;
    }

    /* animação sensação térmica */
    #icFeel.feel-normal{ background: rgba(255,255,255,.86); border-color: rgba(210,222,238,.95); color:#1a2a40; opacity:.92; animation:none; box-shadow:none; }
    #icFeel.feel-hot{
      background: var(--feelHotBg);
      border-color: var(--feelHotLine);
      color: var(--feelHot);
      opacity:1;
      animation: feelPulseHot 1.15s var(--ease) infinite;
      box-shadow: 0 0 0 0 rgba(239,68,68,.0);
    }
    #icFeel.feel-cold{
      background: var(--feelColdBg);
      border-color: var(--feelColdLine);
      color: var(--feelCold);
      opacity:1;
      animation: feelPulseCold 1.25s var(--ease) infinite;
      box-shadow: 0 0 0 0 rgba(59,130,246,.0);
    }
    @keyframes feelPulseHot{
      0%{ box-shadow: 0 0 0 0 rgba(239,68,68,.28); transform: scale(1); }
      55%{ box-shadow: 0 0 0 10px rgba(239,68,68,0); transform: scale(1.02); }
      100%{ box-shadow: 0 0 0 0 rgba(239,68,68,0); transform: scale(1); }
    }
    @keyframes feelPulseCold{
      0%{ box-shadow: 0 0 0 0 rgba(59,130,246,.22); transform: scale(1); }
      60%{ box-shadow: 0 0 0 10px rgba(59,130,246,0); transform: scale(1.02); }
      100%{ box-shadow: 0 0 0 0 rgba(59,130,246,0); transform: scale(1); }
    }

    /* ===== SIDE ===== */
    .sideHeader{
      padding: clamp(16px, 1.8vw, 22px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex:0 0 auto;
      background: transparent;
    }
    .sideHeader .label{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      color:#3b4b62;
      white-space:nowrap;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.95;
    }
    .toggleDots{display:flex; gap:8px; align-items:center;}
    .tdot{
      width:10px; height:10px; border-radius:999px;
      background:#c9d7ea;
      transition: all 420ms var(--ease);
    }
    .tdot.active{background:#2d76b9; width:22px;}

    .slot{
      position:relative;
      flex:1 1 auto;
      min-height:0;
      padding: 0 clamp(14px, 1.6vw, 20px) clamp(14px, 1.6vw, 20px);
      overflow:hidden;
    }
    .view{
      position:absolute;
      inset: clamp(14px, 1.6vw, 20px);
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity var(--anim) var(--ease), transform var(--anim) var(--ease);
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height:0;
      overflow:hidden;
    }
    .view.active{opacity:1; transform: translateY(0); pointer-events:none;}

    .forecastList{
      display:flex;
      flex-direction:column;
      gap: 12px;
      overflow:hidden;
      flex: 1 1 auto;
      min-height:0;
    }
    .fRow{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(210,222,238,.95);
      border-radius: 18px;
      padding: 12px;
      display:grid;
      grid-template-columns: 56px 44px 1fr auto;
      align-items:center;
      gap: 12px;
      min-width:0;
      backdrop-filter: blur(6px);
    }
    .fDow{
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      color:#1a2a40;
      white-space:nowrap;
    }
    .fIcon{
      width:44px; height:44px;
      border-radius: 14px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(210,222,238,.95);
      display:grid;
      place-items:center;
      color:#0f3d63;
      opacity:.95;
      flex:0 0 auto;
    }
    .fIcon svg{width:70%; height:70%}
    .fMid{min-width:0; display:flex; flex-direction:column; gap:6px;}
    .fBadge{
      display:inline-flex;
      align-items:center;
      padding: 8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(210,222,238,.95);
      width: fit-content;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      color:#23344a;
    }
    .fSub{
      font-size: 11px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#3b4b62;
      opacity:.92;
      white-space:nowrap;
    }
    .fTemps{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      white-space:nowrap;
      font-weight: 900;
    }
    .pill{
      position: relative;
      padding: 10px 12px 8px;
      min-width: 52px;
      border-radius: 999px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(210,222,238,.95);
      font-size: 12px;
      font-weight: 900;
      color:#0e1b2a;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .pillTag{
      position:absolute;
      top:5px;
      left:50%;
      transform:translateX(-50%);
      font-size: 9px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .55;
      line-height: 1;
      pointer-events:none;
    }
    .pillTemp{ display:block; margin-top: 10px; font-size: 12px; font-weight: 900; }

    .detailCard{
      border:1px solid rgba(210,222,238,.95);
      border-radius: 20px;
      padding: 14px;
      background: rgba(255,255,255,.78);
      display:flex;
      flex-direction:column;
      gap: 10px;
      backdrop-filter: blur(6px);
      overflow:hidden;
    }
    .bigMinMax{ display:flex; gap: 16px; align-items:flex-end; justify-content:flex-start; flex-wrap:wrap; }
    .mmBlock{display:flex; align-items:baseline; gap:10px;}
    .mmNum{
      font-size: clamp(34px, 3.1vw, 56px);
      font-weight: 900;
      letter-spacing:-0.02em;
      line-height:1;
      color:#0e1b2a;
      white-space:nowrap;
    }
    .mmLbl{
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.12em;
      text-transform: uppercase;
      color:#7a8697;
      white-space:nowrap;
    }
    .detailPills{ display:flex; gap:10px; flex-wrap:wrap; }
    .dPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(210,222,238,.95);
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      color:#23344a;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .dPill svg{width:16px;height:16px;opacity:.9}

    /* ===== progress (ciclo) acima do rodapé ===== */
    .progressWrap{
      flex:0 0 auto;
      padding: 0 var(--pad);
      background:#fff;
    }
    .divider{
      height: 4px;
      border-radius: 999px;
      background: var(--dividerGrad);
      position:relative;
      overflow:hidden;
    }
    #barFill{
      position:absolute;
      inset:0;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,.16), rgba(255,255,255,.38));
      mix-blend-mode: screen;
      border-radius: 999px;
      transition: width 120ms linear;
      transform-origin:left center;
    }

    /* ===== FOOTER ===== */
    .pvFooter{
      flex:0 0 auto;
      height: var(--footerH);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding: 10px var(--pad);
      background:#fff;
      gap: 12px;
      min-width:0;
    }
    .pvLogo{
      height: clamp(16px, 2.3vh, 22px);
      width:auto;
      display:block;
      opacity:.92;
    }

    /* ===== Vertical ===== */
    @media (orientation: portrait){
      .panel{ grid-template-columns: 1fr; }
      .metricsRow{ gap: 10px; }
      .mCard{ padding: 10px 10px; gap: 8px; border-radius: 16px; }
      .mIcon{ width:32px; height:32px; border-radius: 11px; }
      .mLabel{ font-size: 10px; letter-spacing:.12em; }
      .mVal{ font-size: 16px; }

      .slot{ padding: 0 clamp(12px, 1.4vw, 16px) clamp(12px, 1.4vw, 16px); }
      .view{ inset: clamp(12px, 1.4vw, 16px); gap: 10px; }

      .fRow{ padding: 10px; border-radius: 16px; }
      .fDow{ font-size: 13px; }
      .fIcon{ width:42px; height:42px; border-radius: 13px; }
      .fBadge{ padding: 7px 10px; font-size: 11px; }
      .fSub{ font-size: 10px; }
      .pill{ min-width: 48px; padding: 9px 10px 7px; font-size: 11px; }
      .pillTemp{ font-size: 11px; }
      .detailCard{ padding: 12px; border-radius: 18px; }
      .mmNum{ font-size: clamp(30px, 6.2vw, 48px); }
      .dPill{ padding: 9px 11px; font-size: 11px; }
    }

    @media (max-height: 620px){
      #cardWind, #cardHum{ display:none !important; }
      .metricsRow{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="pvShell" id="panel" data-title="PREVISÃO DO TEMPO">
    <header class="pvHeader">
      <div class="pvHeaderLeft">
        <div class="pvIconBadge" aria-hidden="true">
          <span class="material-symbols-outlined">partly_cloudy_day</span>
        </div>
        <div class="pvTitles">
          <h1 class="pvTitle" id="title"></h1>
        </div>
      </div>
      <div class="pvHeaderRight">
        <div class="pvPill">OPEN-METEO</div>
      </div>
    </header>

    <main class="pvMain">
      <div class="panel">
        <!-- HOJE -->
        <section class="card">
          <div class="todayHead">
            <div class="city" id="cityName"><span class="cityText">—</span></div>
          </div>

          <div class="todayCenter">
            <div class="todayWrap">
              <div class="todayIcon" id="todayIcon" aria-hidden="true"></div>
              <div class="tempBlock">
                <div class="tempBig" id="tempToday">--<small>°C</small></div>
                <div class="condLine" id="descToday"><span class="condText">CARREGANDO…</span></div>
              </div>
            </div>
          </div>

          <div class="todayBottom">
            <div class="metricsRow">
              <div class="mCard" id="cardFeel">
                <div class="mLeft">
                  <div class="mIcon feel-normal" aria-hidden="true" id="icFeel"></div>
                  <div class="mLabel">SENSAÇÃO</div>
                </div>
                <div class="mVal" id="feels">--°</div>
              </div>

              <div class="mCard" id="cardWind">
                <div class="mLeft">
                  <div class="mIcon" aria-hidden="true" id="icWind"></div>
                  <div class="mLabel">VENTO</div>
                </div>
                <div class="mVal" id="wind">-- km/h</div>
              </div>

              <div class="mCard" id="cardHum">
                <div class="mLeft">
                  <div class="mIcon" aria-hidden="true" id="icHum"></div>
                  <div class="mLabel">UMIDADE</div>
                </div>
                <div class="mVal" id="humidity">--%</div>
              </div>
            </div>
          </div>
        </section>

        <!-- SIDE -->
        <aside class="card">
          <div class="sideHeader">
            <div class="label" id="sideLabel">PRÓXIMOS DIAS</div>
            <div class="toggleDots" aria-hidden="true">
              <div class="tdot active" id="dotA"></div>
              <div class="tdot" id="dotB"></div>
            </div>
          </div>

          <div class="slot">
            <div class="view active" id="viewA">
              <div class="forecastList" id="forecastList"></div>
            </div>

            <div class="view" id="viewB">
              <div class="detailCard">
                <div class="bigMinMax">
                  <div class="mmBlock">
                    <div class="mmNum" id="tMax">--°</div>
                    <div class="mmLbl">máx</div>
                  </div>
                  <div class="mmBlock">
                    <div class="mmNum" id="tMin">--°</div>
                    <div class="mmLbl">mín</div>
                  </div>
                </div>

                <div class="detailPills">
                  <div class="dPill" id="pillRain"><span id="rainMm">-- mm</span></div>
                  <div class="dPill" id="pillPop"><span id="popPct">--% chuva</span></div>
                  <div class="dPill" id="pillCond"><span id="condTxt">—</span></div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <div class="progressWrap" aria-hidden="true">
      <div class="divider"><div id="barFill"></div></div>
    </div>

    <footer class="pvFooter" aria-label="Rodapé PontoView">
      <img class="pvLogo" src="./assets/logo-pontoview.png" alt="Logo PontoView" />
    </footer>
  </div>

  <script>
    /* =================== CONFIG =================== */
    const DEFAULT_CITY = "Colatina";
    const DEFAULT_UF   = "ES";
    const DEFAULT_LAT  = -19.5397;
    const DEFAULT_LON  = -40.6306;

    const TZ = "America/Sao_Paulo";
    const WEATHER_REFRESH_MIN = 25;

    const ROTATE_MS = 11000;
    const FEEL_COLD_MAX = 19;
    const FEEL_HOT_MIN  = 30;

    let CITY = { city: DEFAULT_CITY, uf: DEFAULT_UF, lat: DEFAULT_LAT, lon: DEFAULT_LON };
    let dailyData = null;
    let isDayNow = true;
    let showingA = true;

    async function fetchJsonWithTimeout(url, ms=6500){
      const ctl = new AbortController();
      const t = setTimeout(()=>ctl.abort(), ms);
      try{
        const r = await fetch(url, { cache:"no-store", signal: ctl.signal });
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } finally {
        clearTimeout(t);
      }
    }

    /* =================== MARQUEE (SEM FADE) =================== */
    function applyMarquee(el, innerSel){
      el.classList.remove("is-marquee");
      el.style.removeProperty("--marqMove");
      el.style.removeProperty("--marqDur");
      const inner = el.querySelector(innerSel);
      if (!inner) return;
      const over = inner.scrollWidth - el.clientWidth;
      if (over > 18){
        el.classList.add("is-marquee");
        el.style.setProperty("--marqMove", `${over}px`);
        const pxPerSec = 45;
        const seconds = Math.max(10, Math.min(20, over / pxPerSec + 7));
        el.style.setProperty("--marqDur", `${seconds}s`);
      }
    }

    /* =================== SVGs (seus originais) =================== */
    function svgCloud(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 17.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 10.2 3.8 3.8 0 0 0 7 17.5h13z"/>
      </svg>`; }
    function svgSun(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="4"></circle>
        <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"></path>
      </svg>`; }
    function svgMoon(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.8A8.5 8.5 0 0 1 11.2 3a7.2 7.2 0 1 0 9.8 9.8Z"></path>
      </svg>`; }
    function svgRain(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h13z"/>
        <path d="M8 19l-1 2"></path>
        <path d="M12 19l-1 2"></path>
        <path d="M16 19l-1 2"></path>
      </svg>`; }
    function svgStorm(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h9"/>
        <path d="M13 14l-2 4h3l-2 4"></path>
      </svg>`; }
    function svgPartly(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="8" cy="8" r="3"></circle>
        <path d="M8 2v1M8 13v1M2 8h1M13 8h1M3.5 3.5l.7.7M11.8 11.8l.7.7M3.5 12.5l.7-.7M11.8 4.2l.7-.7"></path>
        <path d="M20 17.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 8.3 10.1 3.8 3.8 0 0 0 9 17.5h11z"/>
      </svg>`; }
    function svgWind(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 12h11"/>
        <path d="M14 12a3 3 0 1 0-3-3"/>
        <path d="M3 18h15"/>
        <path d="M18 18a3 3 0 1 0-3-3"/>
      </svg>`; }
    function svgDrop(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2s6 7 6 12a6 6 0 0 1-12 0c0-5 6-12 6-12z"/>
      </svg>`; }
    function svgThermo(){ return `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 14.76V5a2 2 0 0 0-4 0v9.76a4 4 0 1 0 4 0z"/>
      </svg>`; }

    function codeToMeta(code, isDay=true){
      if (code === 0) return { icon: isDay ? svgSun() : svgMoon(), text: isDay ? "Ensolarado" : "Céu limpo", kind: isDay ? "sun" : "moon" };
      if (code === 1 || code === 2) return { icon: svgPartly(), text: "Parcialmente nublado", kind:"partly" };
      if (code === 3) return { icon: svgCloud(), text: "Nublado", kind:"cloud" };
      if ([45,48].includes(code)) return { icon: svgCloud(), text: "Neblina", kind:"cloud" };
      if ([51,53,55,61,63,65,80,81,82].includes(code)) return { icon: svgRain(), text: "Chuva", kind:"rain" };
      if ([95,96,99].includes(code)) return { icon: svgStorm(), text: "Tempestade", kind:"storm" };
      return { icon: svgCloud(), text: "Tempo", kind:"cloud" };
    }

    function buildAnimatedTodayIcon(kind){
      if (kind === "rain"){
        return `
          <svg class="animFloat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h13z"/>
            <path class="animRainDrop" d="M8 19l-1 2"></path>
            <path class="animRainDrop" style="animation-delay:.2s" d="M12 19l-1 2"></path>
            <path class="animRainDrop" style="animation-delay:.4s" d="M16 19l-1 2"></path>
          </svg>`;
      }
      if (kind === "storm"){
        return `
          <svg class="animFloat" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 16.5a4.5 4.5 0 0 0-1.3-8.8A6 6 0 0 0 6.2 9.2 3.8 3.8 0 0 0 7 16.5h9"/>
            <path class="animLightning" d="M13 14l-2 4h3l-2 4"></path>
          </svg>`;
      }
      if (kind === "sun") return `<div class="animFloat">${svgSun()}</div>`;
      if (kind === "moon") return `<div class="animFloat">${svgMoon()}</div>`;
      if (kind === "partly") return `<div class="animFloat">${svgPartly()}</div>`;
      return `<div class="animFloat">${svgCloud()}</div>`;
    }

    function dowPT(dateStr){
      const d = new Date(dateStr + "T12:00:00");
      const map = ["DOM","SEG","TER","QUA","QUI","SEX","SÁB"];
      return map[d.getDay()];
    }

    /* icons init */
    document.getElementById("icFeel").innerHTML = svgThermo();
    document.getElementById("icWind").innerHTML = svgWind();
    document.getElementById("icHum").innerHTML = svgDrop();

    function setFeelIconState(apparent){
      const el = document.getElementById("icFeel");
      el.classList.remove("feel-hot","feel-cold","feel-normal");
      if (apparent >= FEEL_HOT_MIN) el.classList.add("feel-hot");
      else if (apparent <= FEEL_COLD_MAX) el.classList.add("feel-cold");
      else el.classList.add("feel-normal");
    }

    /* =================== ROTATION + PROGRESS =================== */
    const viewA = document.getElementById("viewA");
    const viewB = document.getElementById("viewB");
    const dotA = document.getElementById("dotA");
    const dotB = document.getElementById("dotB");
    const sideLabel = document.getElementById("sideLabel");
    const barFill = document.getElementById("barFill");

    let rotStart = performance.now();

    function showA(){
      showingA = true;
      viewA.classList.add("active");
      viewB.classList.remove("active");
      dotA.classList.add("active");
      dotB.classList.remove("active");
      sideLabel.textContent = "PRÓXIMOS DIAS";
      rotStart = performance.now();
    }
    function showB(){
      showingA = false;
      viewB.classList.add("active");
      viewA.classList.remove("active");
      dotB.classList.add("active");
      dotA.classList.remove("active");
      sideLabel.textContent = "DETALHES • HOJE";
      rotStart = performance.now();
    }
    setInterval(()=>{ showingA ? showB() : showA(); }, ROTATE_MS);

    function animateProgress(now){
      const p = ((now - rotStart) % ROTATE_MS) / ROTATE_MS;
      barFill.style.width = `${Math.max(2, p*100)}%`;
      requestAnimationFrame(animateProgress);
    }
    requestAnimationFrame(animateProgress);

    /* =================== FORECAST RENDER =================== */
    function getMaxForecastRows(){
      const isPortrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
      const h = window.innerHeight;
      if (isPortrait) return (h < 780 ? 2 : 3);
      return (h < 720 ? 4 : 5);
    }

    function renderForecastList(){
      const list = document.getElementById("forecastList");
      list.innerHTML = "";
      if(!dailyData) return;

      const { time, weather_code, temperature_2m_max, temperature_2m_min, precipitation_probability_max, precipitation_sum } = dailyData;

      const maxRows = getMaxForecastRows();
      const start = 1;
      const end = Math.min(time.length, start + maxRows);

      for(let i=start; i<end; i++){
        const meta = codeToMeta(weather_code[i], true);
        const pop = precipitation_probability_max?.[i] ?? 0;
        const mm = (precipitation_sum?.[i] ?? 0);
        const max = Math.round(temperature_2m_max[i]);
        const min = Math.round(temperature_2m_min[i]);

        const row = document.createElement("div");
        row.className = "fRow";
        row.innerHTML = `
          <div class="fDow">${dowPT(time[i])}</div>
          <div class="fIcon" aria-hidden="true">${meta.icon}</div>
          <div class="fMid">
            <div class="fBadge">${meta.text}</div>
            <div class="fSub">${Math.round(mm*10)/10} mm • ${Math.round(pop)}%</div>
          </div>
          <div class="fTemps">
            <span class="pill">
              <span class="pillTag">MÁX</span>
              <span class="pillTemp">${max}°</span>
            </span>
            <span class="pill" style="opacity:.75">
              <span class="pillTag">MÍN</span>
              <span class="pillTemp">${min}°</span>
            </span>
          </div>`;
        list.appendChild(row);
      }
    }

    function renderTodayDetails(){
      if(!dailyData) return;

      const { weather_code, temperature_2m_max, temperature_2m_min, precipitation_probability_max, precipitation_sum } = dailyData;

      const idx = 0;
      const meta = codeToMeta(weather_code[idx], isDayNow);
      const pop = precipitation_probability_max?.[idx] ?? 0;
      const mm = (precipitation_sum?.[idx] ?? 0);
      const max = Math.round(temperature_2m_max[idx]);
      const min = Math.round(temperature_2m_min[idx]);

      document.getElementById("tMax").textContent = `${max}°`;
      document.getElementById("tMin").textContent = `${min}°`;

      document.getElementById("pillCond").innerHTML = `${meta.icon}<span id="condTxt">${meta.text.toUpperCase()}</span>`;
      document.getElementById("pillRain").innerHTML = `${svgRain()}<span id="rainMm">${Math.round(mm*10)/10} mm</span>`;
      document.getElementById("pillPop").innerHTML = `${svgDrop()}<span id="popPct">${Math.round(pop)}% chuva</span>`;
    }

    /* =================== OPEN-METEO =================== */
    async function loadWeather(){
      const url = new URL("https://api.open-meteo.com/v1/forecast");
      url.searchParams.set("latitude", CITY.lat);
      url.searchParams.set("longitude", CITY.lon);
      url.searchParams.set("timezone", TZ);
      url.searchParams.set("current", "temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,is_day");
      url.searchParams.set("daily", "weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum");
      url.searchParams.set("forecast_days", "6");

      const data = await fetchJsonWithTimeout(url.toString(), 7500);

      const cityLabel = `${(CITY.city || DEFAULT_CITY)} • ${(CITY.uf || DEFAULT_UF)}`.toUpperCase();
      const cityEl = document.getElementById("cityName");
      cityEl.querySelector(".cityText").textContent = cityLabel;

      const cur = data.current;
      isDayNow = (cur.is_day === 1);

      const meta = codeToMeta(cur.weather_code, isDayNow);

      document.getElementById("tempToday").innerHTML = `${Math.round(cur.temperature_2m)}<small>°C</small>`;

      const descEl = document.getElementById("descToday");
      descEl.querySelector(".condText").textContent = meta.text.toUpperCase();

      document.getElementById("todayIcon").innerHTML = buildAnimatedTodayIcon(meta.kind);

      const feels = Math.round(cur.apparent_temperature);
      document.getElementById("feels").textContent = `${feels}°`;
      setFeelIconState(feels);

      document.getElementById("wind").textContent = `${Math.round(cur.wind_speed_10m)} km/h`;
      document.getElementById("humidity").textContent = `${Math.round(cur.relative_humidity_2m)}%`;

      dailyData = data.daily;
      renderForecastList();
      renderTodayDetails();

      requestAnimationFrame(() => {
        applyMarquee(cityEl, ".cityText");
        applyMarquee(descEl, ".condText");
      });
    }

    /* =================== LOCATION (IP) + REVERSE =================== */
    function parseFromURL(){
      const p = new URLSearchParams(location.search);
      const city = (p.get("city") || "").trim();
      const uf = (p.get("uf") || "").trim();
      const lat = parseFloat((p.get("lat") || "").replace(",", "."));
      const lon = parseFloat((p.get("lon") || "").replace(",", "."));
      const out = {};
      if (city) out.city = city;
      if (uf) out.uf = uf.toUpperCase();
      if (Number.isFinite(lat)) out.lat = lat;
      if (Number.isFinite(lon)) out.lon = lon;
      return out;
    }

    async function refineCityByReverseGeocode(lat, lon){
      try{
        const url = new URL("https://geocoding-api.open-meteo.com/v1/reverse");
        url.searchParams.set("latitude", String(lat));
        url.searchParams.set("longitude", String(lon));
        url.searchParams.set("language", "pt");
        url.searchParams.set("count", "1");
        const g = await fetchJsonWithTimeout(url.toString(), 6500);
        const r = g && g.results && g.results[0];
        if (!r) return null;
        return {
          city: (r.name ? String(r.name).trim() : ""),
          uf: (r.admin1_code ? String(r.admin1_code).trim().toUpperCase() : "")
        };
      }catch(e){ return null; }
    }

    async function resolveCity(){
      try{
        const u = parseFromURL();
        if (u.city) CITY.city = u.city;
        if (u.uf) CITY.uf = u.uf;
        if (Number.isFinite(u.lat)) CITY.lat = u.lat;
        if (Number.isFinite(u.lon)) CITY.lon = u.lon;

        if (Number.isFinite(CITY.lat) && Number.isFinite(CITY.lon)){
          const refined = await refineCityByReverseGeocode(CITY.lat, CITY.lon);
          if (refined?.city) CITY.city = refined.city;
          if (refined?.uf) CITY.uf = refined.uf;
          return;
        }
      }catch(e){}

      try{
        const d = await fetchJsonWithTimeout("https://ipwho.is/", 6500);
        if (d && d.success){
          const lat = Number(d.latitude);
          const lon = Number(d.longitude);

          if (d.city) CITY.city = String(d.city).trim();
          CITY.uf = String(d.region_code || CITY.uf || "").trim().toUpperCase();

          if (Number.isFinite(lat) && Number.isFinite(lon)){
            CITY.lat = lat; CITY.lon = lon;
            const refined = await refineCityByReverseGeocode(CITY.lat, CITY.lon);
            if (refined?.city) CITY.city = refined.city;
            if (refined?.uf) CITY.uf = refined.uf;
          }
          return;
        }
      }catch(e){}

      CITY.city = CITY.city || DEFAULT_CITY;
      CITY.uf = CITY.uf || DEFAULT_UF;
      CITY.lat = Number.isFinite(CITY.lat) ? CITY.lat : DEFAULT_LAT;
      CITY.lon = Number.isFinite(CITY.lon) ? CITY.lon : DEFAULT_LON;
    }

    /* =================== BOOT =================== */
    document.getElementById("title").textContent = document.getElementById("panel").dataset.title || "PREVISÃO DO TEMPO";

    let resizeT = null;
    window.addEventListener("resize", ()=>{
      clearTimeout(resizeT);
      resizeT = setTimeout(()=>{
        renderForecastList();
        renderTodayDetails();
        applyMarquee(document.getElementById("cityName"), ".cityText");
        applyMarquee(document.getElementById("descToday"), ".condText");
      }, 150);
    });

    (async ()=>{
      try{
        await resolveCity();
        await loadWeather();
      }catch(err){
        document.querySelector("#descToday .condText").textContent = "SEM CONEXÃO";
        const cityLabel = `${(CITY.city || DEFAULT_CITY)} • ${(CITY.uf || DEFAULT_UF)}`.toUpperCase();
        document.querySelector("#cityName .cityText").textContent = cityLabel;
      }
      setInterval(()=>loadWeather().catch(()=>{}), 1000 * 60 * WEATHER_REFRESH_MIN);
    })();

    showA();
  </script>
</body>
</html>
